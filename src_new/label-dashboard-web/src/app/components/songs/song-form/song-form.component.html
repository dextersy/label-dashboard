<!-- Modal backdrop -->
<div *ngIf="isVisible" class="modal-backdrop fade show" (click)="onClose()"></div>

<!-- Modal -->
<div *ngIf="isVisible" class="modal fade show" style="display: block" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">
          <i class="fa fa-music mr-2"></i>
          {{ isEditMode ? 'Edit Song' : 'Add Song' }}
        </h4>
        <button type="button" class="close" (click)="onClose()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Info Message for Non-Draft Releases -->
        <div *ngIf="isEditMode && isRestrictedMode()" class="alert alert-info mb-3">
          <i class="fa fa-info-circle me-2"></i>
          <strong>This release is {{ releaseStatus }}.</strong> You can only do limited edits. Contact your label administrator if you need to change more information.
        </div>

        <form (ngSubmit)="onSubmit()" #songFormRef="ngForm">
          <!-- Basic Information -->
          <h5 class="mb-3">Basic Information</h5>

          <div class="form-group">
            <label for="songTitle">Song Title <span class="text-danger">*</span></label>
            <input
              type="text"
              class="form-control"
              id="songTitle"
              [(ngModel)]="songForm.title"
              name="title"
              placeholder="Enter song title"
              required
              maxlength="255"
              [readonly]="isRestrictedMode()">
            <small class="form-text text-muted">Track will be added as the last track in the release</small>
          </div>

          <div class="row" *ngIf="isAdmin">
            <div class="col-md-6">
              <div class="form-group">
                <label for="duration">Duration (seconds)</label>
                <input
                  type="number"
                  class="form-control"
                  id="duration"
                  [(ngModel)]="songForm.duration"
                  name="duration"
                  placeholder="180"
                  min="0"
                  [readonly]="isRestrictedMode()">
                <small class="form-text text-muted">Duration in seconds (e.g., 180 = 3:00)</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="isrc">ISRC Code</label>
                <input
                  type="text"
                  class="form-control"
                  id="isrc"
                  [(ngModel)]="songForm.isrc"
                  name="isrc"
                  placeholder="US-XXX-XX-XXXXX"
                  maxlength="20"
                  [readonly]="isRestrictedMode()">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="lyrics">Lyrics</label>
            <textarea
              class="form-control"
              id="lyrics"
              [(ngModel)]="songForm.lyrics"
              name="lyrics"
              rows="4"
              placeholder="Enter song lyrics..."></textarea>
          </div>

          <!-- Streaming Links -->
          <div *ngIf="isAdmin">
            <h5 class="mb-3 mt-4">Streaming Links</h5>

            <div class="form-group">
              <label for="spotifyLink">Spotify Link</label>
              <input
                type="url"
                class="form-control"
                id="spotifyLink"
                [(ngModel)]="songForm.spotify_link"
                name="spotify_link"
                placeholder="https://open.spotify.com/track/..."
                [readonly]="isRestrictedMode()">
            </div>

            <div class="form-group">
              <label for="appleMusicLink">Apple Music Link</label>
              <input
                type="url"
                class="form-control"
                id="appleMusicLink"
                [(ngModel)]="songForm.apple_music_link"
                name="apple_music_link"
                placeholder="https://music.apple.com/..."
                [readonly]="isRestrictedMode()">
            </div>

            <div class="form-group">
              <label for="youtubeLink">YouTube Link</label>
              <input
                type="url"
                class="form-control"
                id="youtubeLink"
                [(ngModel)]="songForm.youtube_link"
                name="youtube_link"
                placeholder="https://www.youtube.com/watch?v=..."
                [readonly]="isRestrictedMode()">
            </div>
          </div>

          <!-- Collaborators -->
          <h5 class="mb-3 mt-4">Collaborators (Artists)</h5>

          <div class="card mb-3">
            <div class="card-body">
              <!-- Release Artists (non-editable) -->
              <div *ngIf="releaseArtists.length > 0" class="mb-3">
                <label class="d-block mb-2"><small class="text-muted">Release artists (automatically included):</small></label>
                <div *ngFor="let artist of releaseArtists" class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded bg-light">
                  <div>
                    <strong>{{ artist.name }}</strong>
                    <span class="badge badge-secondary ml-2">Release Artist</span>
                  </div>
                </div>
              </div>

              <!-- Additional Collaborators (editable) -->
              <label class="d-block mb-2"><small class="text-muted">Additional collaborators:</small></label>
              <div class="row">
                <div class="col-md-10">
                  <select class="form-control" [(ngModel)]="newCollaborator.artist_id" name="new_collaborator_artist" (blur)="onCollaboratorBlur()" [disabled]="isRestrictedMode()">
                    <option [value]="0">Select an artist...</option>
                    <option *ngFor="let artist of artists" [value]="artist.id" [disabled]="releaseArtistIds.includes(artist.id)">{{ artist.name }}</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <button type="button" class="btn btn-success btn-block" (click)="addCollaborator()" [disabled]="isRestrictedMode()">
                    <i class="fa fa-plus"></i>
                  </button>
                </div>
              </div>

              <div *ngIf="songForm.collaborators.length > 0" class="mt-3">
                <div *ngFor="let collab of songForm.collaborators; let i = index" class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                  <div>
                    <strong>{{ getArtistName(collab.artist_id) }}</strong>
                  </div>
                  <button type="button" class="btn btn-sm btn-danger" (click)="removeCollaborator(i)" [disabled]="isRestrictedMode()">
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Authors -->
          <h5 class="mb-3 mt-4">Authors (Lyricists)</h5>

          <div class="card mb-3">
            <div class="card-body">
              <div class="row">
                <div [class]="isAdmin ? 'col-md-4' : 'col-md-11'">
                  <input
                    type="text"
                    class="form-control"
                    [(ngModel)]="newAuthor.name"
                    name="new_author_name"
                    placeholder="Author name"
                    (blur)="onAuthorNameBlur()"
                    [readonly]="isRestrictedMode()">
                </div>
                <div class="col-md-3" *ngIf="isAdmin">
                  <input
                    type="text"
                    class="form-control"
                    [(ngModel)]="newAuthor.pro_affiliation"
                    name="new_author_pro"
                    placeholder="PRO (e.g., ASCAP)"
                    [readonly]="isRestrictedMode()">
                </div>
                <div class="col-md-2" *ngIf="isAdmin">
                  <input
                    type="text"
                    class="form-control"
                    [(ngModel)]="newAuthor.ipi_number"
                    name="new_author_ipi"
                    placeholder="IPI#"
                    [readonly]="isRestrictedMode()">
                </div>
                <div class="col-md-2" *ngIf="isAdmin">
                  <input
                    type="number"
                    class="form-control"
                    [(ngModel)]="newAuthor.share_percentage"
                    name="new_author_share"
                    placeholder="Share %"
                    min="0"
                    max="100"
                    step="0.01"
                    [readonly]="isRestrictedMode()">
                </div>
                <div class="col-md-1">
                  <button type="button" class="btn btn-success btn-block" (click)="addAuthor()" [disabled]="isRestrictedMode()">
                    <i class="fa fa-plus"></i>
                  </button>
                </div>
              </div>

              <div *ngIf="songForm.authors.length > 0" class="mt-3">
                <div *ngFor="let author of songForm.authors; let i = index" class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                  <div>
                    <strong>{{ author.name }}</strong>
                    <span *ngIf="isAdmin && author.pro_affiliation" class="text-muted ml-2">({{ author.pro_affiliation }})</span>
                    <span *ngIf="isAdmin && author.share_percentage" class="badge badge-info ml-2">{{ author.share_percentage }}%</span>
                  </div>
                  <button type="button" class="btn btn-sm btn-danger" (click)="removeAuthor(i)" [disabled]="isRestrictedMode()">
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Composers -->
          <h5 class="mb-3 mt-4">Composers</h5>

          <div class="card mb-3">
            <div class="card-body">
              <div class="row">
                <div [class]="isAdmin ? 'col-md-4' : 'col-md-11'">
                  <input
                    type="text"
                    class="form-control"
                    [(ngModel)]="newComposer.name"
                    name="new_composer_name"
                    placeholder="Composer name"
                    (blur)="onComposerNameBlur()"
                    [readonly]="isRestrictedMode()">
                </div>
                <div class="col-md-3" *ngIf="isAdmin">
                  <input
                    type="text"
                    class="form-control"
                    [(ngModel)]="newComposer.pro_affiliation"
                    name="new_composer_pro"
                    placeholder="PRO (e.g., ASCAP)"
                    [readonly]="isRestrictedMode()">
                </div>
                <div class="col-md-2" *ngIf="isAdmin">
                  <input
                    type="text"
                    class="form-control"
                    [(ngModel)]="newComposer.ipi_number"
                    name="new_composer_ipi"
                    placeholder="IPI#"
                    [readonly]="isRestrictedMode()">
                </div>
                <div class="col-md-2" *ngIf="isAdmin">
                  <input
                    type="number"
                    class="form-control"
                    [(ngModel)]="newComposer.share_percentage"
                    name="new_composer_share"
                    placeholder="Share %"
                    min="0"
                    max="100"
                    step="0.01"
                    [readonly]="isRestrictedMode()">
                </div>
                <div class="col-md-1">
                  <button type="button" class="btn btn-success btn-block" (click)="addComposer()" [disabled]="isRestrictedMode()">
                    <i class="fa fa-plus"></i>
                  </button>
                </div>
              </div>

              <div *ngIf="songForm.composers.length > 0" class="mt-3">
                <div *ngFor="let composer of songForm.composers; let i = index" class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                  <div>
                    <strong>{{ composer.name }}</strong>
                    <span *ngIf="isAdmin && composer.pro_affiliation" class="text-muted ml-2">({{ composer.pro_affiliation }})</span>
                    <span *ngIf="isAdmin && composer.share_percentage" class="badge badge-info ml-2">{{ composer.share_percentage }}%</span>
                  </div>
                  <button type="button" class="btn btn-sm btn-danger" (click)="removeComposer(i)" [disabled]="isRestrictedMode()">
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="onClose()"
          [disabled]="isSubmitting">
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="onSubmit()"
          [disabled]="!isFormValid || isSubmitting">
          <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm mr-1" role="status"></span>
          {{ isSubmitting ? 'Saving...' : (isEditMode ? 'Update Song' : 'Add Song') }}
        </button>
      </div>
    </div>
  </div>
</div>
