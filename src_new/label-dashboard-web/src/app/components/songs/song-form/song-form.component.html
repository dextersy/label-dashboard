<!-- Modal backdrop -->
<div *ngIf="isVisible" class="modal-backdrop fade show" (click)="onClose()"></div>

<!-- Modal -->
<div *ngIf="isVisible" class="modal fade show modal-display" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">
          <i class="fa fa-music mr-2"></i>
          {{ isEditMode ? 'Edit Song' : 'Add Song' }}
        </h4>
        <button type="button" class="close" (click)="onClose()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Info Message for Non-Draft Releases -->
        <div *ngIf="isEditMode && isRestrictedMode()" class="alert alert-info mb-3">
          <i class="fa fa-info-circle me-2"></i>
          <strong>This release is {{ releaseStatus }}.</strong> You can only do limited edits. Contact your label administrator if you need to change more information.
        </div>

        <form (ngSubmit)="onSubmit()" #songFormRef="ngForm">
          <!-- Basic Information -->
          <h5 class="mb-3">Basic Information</h5>

          <div class="form-group">
            <label for="songTitle">Song Title <span class="text-danger">*</span></label>
            <input
              type="text"
              class="form-control"
              id="songTitle"
              [(ngModel)]="songForm.title"
              name="title"
              placeholder="Enter song title"
              required
              maxlength="255"
              [readonly]="isRestrictedMode()">
          </div>

          <div class="row" *ngIf="isAdmin">
            <div class="col-md-6">
              <div class="form-group">
                <label for="duration">Duration (seconds)</label>
                <input
                  type="number"
                  class="form-control"
                  id="duration"
                  [(ngModel)]="songForm.duration"
                  name="duration"
                  placeholder="180"
                  min="0"
                  [readonly]="isRestrictedMode()">
                <small class="form-text text-muted">Duration in seconds (e.g., 180 = 3:00)</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="isrc">ISRC Code</label>
                <input
                  type="text"
                  class="form-control"
                  id="isrc"
                  [(ngModel)]="songForm.isrc"
                  name="isrc"
                  placeholder="US-XXX-XX-XXXXX"
                  maxlength="20"
                  [readonly]="isRestrictedMode()">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="lyrics">Lyrics</label>
            <textarea
              class="form-control"
              id="lyrics"
              [(ngModel)]="songForm.lyrics"
              name="lyrics"
              rows="4"
              placeholder="Enter song lyrics..."></textarea>
          </div>

          <!-- Streaming Links -->
          <div *ngIf="isAdmin">
            <h5 class="mb-3 mt-4">Streaming Links</h5>

            <div class="form-group">
              <label for="spotifyLink">Spotify Link</label>
              <input
                type="url"
                class="form-control"
                id="spotifyLink"
                [(ngModel)]="songForm.spotify_link"
                name="spotify_link"
                placeholder="https://open.spotify.com/track/..."
                [readonly]="isRestrictedMode()">
            </div>

            <div class="form-group">
              <label for="appleMusicLink">Apple Music Link</label>
              <input
                type="url"
                class="form-control"
                id="appleMusicLink"
                [(ngModel)]="songForm.apple_music_link"
                name="apple_music_link"
                placeholder="https://music.apple.com/..."
                [readonly]="isRestrictedMode()">
            </div>

            <div class="form-group">
              <label for="youtubeLink">YouTube Link</label>
              <input
                type="url"
                class="form-control"
                id="youtubeLink"
                [(ngModel)]="songForm.youtube_link"
                name="youtube_link"
                placeholder="https://www.youtube.com/watch?v=..."
                [readonly]="isRestrictedMode()">
            </div>
          </div>

          <!-- Collaborators -->
          <h5 class="mb-3 mt-4">Collaborators (Artists)</h5>
          <p class="text-muted small mb-3">
            Indicate performing artists that are involved in this track. If the artist you collaborated with does not appear, inform your label administrator.
          </p>

          <div class="card mb-3" [class.z-index-high]="showCollaboratorDropdown" [class.z-index-collaborators]="!showCollaboratorDropdown">
            <div class="card-body overflow-visible">
              <div class="chip-input-wrapper">
                <div class="chip-input-field"
                     [class.focused]="collaboratorInputFocused"
                     [class.readonly]="isRestrictedMode()"
                     (click)="!isRestrictedMode() && onCollaboratorInputFocus()">

                  <!-- Release Artists (non-removable) -->
                  <span *ngFor="let artist of releaseArtists" class="chip-input-badge chip-input-badge-release">
                    {{ artist.name }}
                  </span>

                  <!-- Additional Collaborators (removable) -->
                  <span *ngFor="let collab of songForm.collaborators; let i = index" class="chip-input-badge">
                    {{ getArtistName(collab.artist_id) }}
                    <button type="button"
                            class="chip-input-remove"
                            (click)="removeCollaborator(i); $event.stopPropagation()"
                            [disabled]="isRestrictedMode()"
                            title="Remove">
                      ×
                    </button>
                  </span>

                  <!-- Placeholder input (no typing allowed) -->
                  <input type="text"
                         class="chip-input-text no-input"
                         placeholder="Click to select artists..."
                         readonly
                         (focus)="onCollaboratorInputFocus()"
                         (blur)="onCollaboratorInputBlur()"
                         [disabled]="isRestrictedMode()">
                </div>

                <!-- Dropdown -->
                <div *ngIf="showCollaboratorDropdown && !isRestrictedMode()" class="chip-input-dropdown">
                  <button *ngFor="let artist of artists"
                          type="button"
                          class="chip-dropdown-item"
                          [disabled]="releaseArtistIds.includes(artist.id) || isArtistAlreadyAdded(artist.id)"
                          (click)="selectCollaboratorFromDropdown(artist.id)">
                    {{ artist.name }}
                    <span *ngIf="releaseArtistIds.includes(artist.id)" class="text-muted small"> (Release artist)</span>
                    <span *ngIf="isArtistAlreadyAdded(artist.id)" class="text-muted small"> (Already added)</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Authors -->
          <h5 class="mb-3 mt-4">Authors (Lyricists)</h5>
          <p class="text-muted small mb-3">
            Indicate people who contributed to the lyrics of this song. Select from the list of songwriters in our database or add a new songwriter.
          </p>

          <div class="card mb-3" [class.z-index-high]="showAuthorDropdown || isCreatingNewAuthor" [class.z-index-authors]="!showAuthorDropdown && !isCreatingNewAuthor">
            <div class="card-body overflow-visible">
              <!-- Chip input with search -->
              <div class="chip-input-wrapper">
                <div class="chip-input-field"
                     [class.focused]="authorInputFocused && !isCreatingNewAuthor"
                     [class.readonly]="isRestrictedMode() || isCreatingNewAuthor"
                     (click)="!isRestrictedMode() && !isCreatingNewAuthor && chipInputField.focus()">

                  <!-- Added Authors as chips -->
                  <span *ngFor="let author of songForm.authors; let i = index" class="chip-input-badge">
                    {{ getSongwriterDisplay(author) }}
                    <span *ngIf="author.songwriter_id === 0" class="chip-new-indicator" title="New songwriter">⭐</span>
                    <span *ngIf="isAdmin && author.share_percentage" class="ml-1">({{ author.share_percentage }}%)</span>
                    <button type="button"
                            class="chip-input-remove"
                            (click)="removeAuthor(i); $event.stopPropagation()"
                            [disabled]="isRestrictedMode() || isCreatingNewAuthor"
                            title="Remove">
                      ×
                    </button>
                  </span>

                  <!-- Text input for search -->
                  <input #chipInputField
                         type="text"
                         class="chip-input-text"
                         [(ngModel)]="newAuthor.name"
                         name="new_author_name"
                         placeholder="Type to search or add songwriter..."
                         (input)="onAuthorNameChange()"
                         (focus)="onAuthorInputFocusChip()"
                         (blur)="onAuthorInputBlur(); hideAuthorDropdown()"
                         (keydown.enter)="onAuthorEnterKey($event)"
                         [readonly]="isRestrictedMode() || isCreatingNewAuthor"
                         autocomplete="off">
                </div>

                <!-- Autocomplete dropdown -->
                <div *ngIf="showAuthorDropdown && !isCreatingNewAuthor" class="chip-input-dropdown">
                  <!-- Create new option at TOP -->
                  <button type="button"
                          class="chip-dropdown-item create-new-item"
                          (click)="createNewAuthor()">
                    <i class="fa fa-plus-circle"></i>
                    <span *ngIf="newAuthor.name.trim()"> Create new songwriter "{{ newAuthor.name }}"</span>
                    <span *ngIf="!newAuthor.name.trim()"> Create new songwriter...</span>
                  </button>
                  <!-- Existing songwriters below -->
                  <button type="button"
                          *ngFor="let songwriter of filteredAuthorSongwriters"
                          class="chip-dropdown-item"
                          (click)="selectAuthorSongwriter(songwriter)">
                    <strong>{{ songwriter.name }}</strong>
                    <span *ngIf="songwriter.pro_affiliation" class="text-muted"> ({{ songwriter.pro_affiliation }})</span>
                    <span *ngIf="songwriter.ipi_number" class="text-muted small"> - IPI: {{ songwriter.ipi_number }}</span>
                  </button>
                </div>
              </div>

              <!-- Create new songwriter form (shown when in create mode) -->
              <div *ngIf="isCreatingNewAuthor" class="create-songwriter-form">
                <h6 class="mb-3">Create New Songwriter</h6>
                <div class="row">
                  <div class="col-md-12 mb-2">
                    <label for="newAuthorName" class="form-label mb-1"><small>Name <span class="text-danger">*</span></small></label>
                    <input
                      type="text"
                      id="newAuthorName"
                      class="form-control form-control-sm"
                      [(ngModel)]="newAuthor.name"
                      name="new_author_name_create"
                      placeholder="Songwriter name"
                      [readonly]="isRestrictedMode()">
                  </div>
                  <div class="col-md-6 mb-2">
                    <label for="newAuthorPro" class="form-label mb-1"><small>PRO Affiliation (optional)</small></label>
                    <input
                      type="text"
                      id="newAuthorPro"
                      class="form-control form-control-sm"
                      [(ngModel)]="newAuthor.pro_affiliation"
                      name="new_author_pro_create"
                      placeholder="e.g., ASCAP, BMI"
                      [readonly]="isRestrictedMode()">
                  </div>
                  <div class="col-md-6 mb-2">
                    <label for="newAuthorIpi" class="form-label mb-1"><small>IPI Number (optional)</small></label>
                    <input
                      type="text"
                      id="newAuthorIpi"
                      class="form-control form-control-sm"
                      [(ngModel)]="newAuthor.ipi_number"
                      name="new_author_ipi_create"
                      placeholder="IPI Number"
                      [readonly]="isRestrictedMode()">
                  </div>
                  <div class="col-md-6 mb-2" *ngIf="isAdmin">
                    <label for="newAuthorShare" class="form-label mb-1"><small>Share % (optional)</small></label>
                    <input
                      type="number"
                      id="newAuthorShare"
                      class="form-control form-control-sm"
                      [(ngModel)]="newAuthor.share_percentage"
                      name="new_author_share_create"
                      placeholder="Share %"
                      min="0"
                      max="100"
                      step="0.01"
                      [readonly]="isRestrictedMode()">
                  </div>
                </div>
                <div class="mt-3">
                  <button type="button" class="btn btn-success btn-sm mr-2" (click)="addAuthor()" [disabled]="isRestrictedMode() || !newAuthor.name.trim()">
                    <i class="fa fa-check"></i> Add
                  </button>
                  <button type="button" class="btn btn-secondary btn-sm" (click)="cancelNewAuthor()" [disabled]="isRestrictedMode()">
                    <i class="fa fa-times"></i> Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Composers -->
          <h5 class="mb-3 mt-4">Composers</h5>
          <p class="text-muted small mb-3">
            Indicate who contributed to the music for each track. Generally, "composer" refers to who made the main melody of the song (the tune that is sung), but you can take liberty to decide who should be credited for the music. Select from the list of songwriters in our database or add a new songwriter.
          </p>

          <div class="card mb-3" [class.z-index-high]="showComposerDropdown || isCreatingNewComposer" [class.z-index-composers]="!showComposerDropdown && !isCreatingNewComposer">
            <div class="card-body overflow-visible">
              <!-- Chip input with search -->
              <div class="chip-input-wrapper">
                <div class="chip-input-field"
                     [class.focused]="composerInputFocused && !isCreatingNewComposer"
                     [class.readonly]="isRestrictedMode() || isCreatingNewComposer"
                     (click)="!isRestrictedMode() && !isCreatingNewComposer && composerChipInputField.focus()">

                  <!-- Added Composers as chips -->
                  <span *ngFor="let composer of songForm.composers; let i = index" class="chip-input-badge">
                    {{ getSongwriterDisplay(composer) }}
                    <span *ngIf="composer.songwriter_id === 0" class="chip-new-indicator" title="New songwriter">⭐</span>
                    <span *ngIf="isAdmin && composer.share_percentage" class="ml-1">({{ composer.share_percentage }}%)</span>
                    <button type="button"
                            class="chip-input-remove"
                            (click)="removeComposer(i); $event.stopPropagation()"
                            [disabled]="isRestrictedMode() || isCreatingNewComposer"
                            title="Remove">
                      ×
                    </button>
                  </span>

                  <!-- Text input for search -->
                  <input #composerChipInputField
                         type="text"
                         class="chip-input-text"
                         [(ngModel)]="newComposer.name"
                         name="new_composer_name"
                         placeholder="Type to search or add songwriter..."
                         (input)="onComposerNameChange()"
                         (focus)="onComposerInputFocusChip()"
                         (blur)="onComposerInputBlur(); hideComposerDropdown()"
                         (keydown.enter)="onComposerEnterKey($event)"
                         [readonly]="isRestrictedMode() || isCreatingNewComposer"
                         autocomplete="off">
                </div>

                <!-- Autocomplete dropdown -->
                <div *ngIf="showComposerDropdown && !isCreatingNewComposer" class="chip-input-dropdown">
                  <!-- Create new option at TOP -->
                  <button type="button"
                          class="chip-dropdown-item create-new-item"
                          (click)="createNewComposer()">
                    <i class="fa fa-plus-circle"></i>
                    <span *ngIf="newComposer.name.trim()"> Create new songwriter "{{ newComposer.name }}"</span>
                    <span *ngIf="!newComposer.name.trim()"> Create new songwriter...</span>
                  </button>
                  <!-- Existing songwriters below -->
                  <button type="button"
                          *ngFor="let songwriter of filteredComposerSongwriters"
                          class="chip-dropdown-item"
                          (click)="selectComposerSongwriter(songwriter)">
                    <strong>{{ songwriter.name }}</strong>
                    <span *ngIf="songwriter.pro_affiliation" class="text-muted"> ({{ songwriter.pro_affiliation }})</span>
                    <span *ngIf="songwriter.ipi_number" class="text-muted small"> - IPI: {{ songwriter.ipi_number }}</span>
                  </button>
                </div>
              </div>

              <!-- Create new songwriter form (shown when in create mode) -->
              <div *ngIf="isCreatingNewComposer" class="create-songwriter-form">
                <h6 class="mb-3">Create New Songwriter</h6>
                <div class="row">
                  <div class="col-md-12 mb-2">
                    <label for="newComposerName" class="form-label mb-1"><small>Name <span class="text-danger">*</span></small></label>
                    <input
                      type="text"
                      id="newComposerName"
                      class="form-control form-control-sm"
                      [(ngModel)]="newComposer.name"
                      name="new_composer_name_create"
                      placeholder="Songwriter name"
                      [readonly]="isRestrictedMode()">
                  </div>
                  <div class="col-md-6 mb-2">
                    <label for="newComposerPro" class="form-label mb-1"><small>PRO Affiliation (optional)</small></label>
                    <input
                      type="text"
                      id="newComposerPro"
                      class="form-control form-control-sm"
                      [(ngModel)]="newComposer.pro_affiliation"
                      name="new_composer_pro_create"
                      placeholder="e.g., ASCAP, BMI"
                      [readonly]="isRestrictedMode()">
                  </div>
                  <div class="col-md-6 mb-2">
                    <label for="newComposerIpi" class="form-label mb-1"><small>IPI Number (optional)</small></label>
                    <input
                      type="text"
                      id="newComposerIpi"
                      class="form-control form-control-sm"
                      [(ngModel)]="newComposer.ipi_number"
                      name="new_composer_ipi_create"
                      placeholder="IPI Number"
                      [readonly]="isRestrictedMode()">
                  </div>
                  <div class="col-md-6 mb-2" *ngIf="isAdmin">
                    <label for="newComposerShare" class="form-label mb-1"><small>Share % (optional)</small></label>
                    <input
                      type="number"
                      id="newComposerShare"
                      class="form-control form-control-sm"
                      [(ngModel)]="newComposer.share_percentage"
                      name="new_composer_share_create"
                      placeholder="Share %"
                      min="0"
                      max="100"
                      step="0.01"
                      [readonly]="isRestrictedMode()">
                  </div>
                </div>
                <div class="mt-3">
                  <button type="button" class="btn btn-success btn-sm mr-2" (click)="addComposer()" [disabled]="isRestrictedMode() || !newComposer.name.trim()">
                    <i class="fa fa-check"></i> Add
                  </button>
                  <button type="button" class="btn btn-secondary btn-sm" (click)="cancelNewComposer()" [disabled]="isRestrictedMode()">
                    <i class="fa fa-times"></i> Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="onClose()"
          [disabled]="isSubmitting">
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="onSubmit()"
          [disabled]="!isFormValid || isSubmitting">
          <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm mr-1" role="status"></span>
          {{ isSubmitting ? 'Saving...' : (isEditMode ? 'Update Song' : 'Add Song') }}
        </button>
      </div>
    </div>
  </div>
</div>
