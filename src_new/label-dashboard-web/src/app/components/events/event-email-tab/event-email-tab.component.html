<div class="event-email-tab">
  
  <div *ngIf="selectedEvent">
    <!-- Recipients Info -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="alert alert-info d-flex align-items-center">
          <i class="fas fa-info-circle me-2"></i>
          <div>
            <strong>To:</strong> 
            <span *ngIf="loadingCount">Loading recipients...</span>
            <span *ngIf="!loadingCount" class="text-primary fw-bold">
              {{ recipientsCount }} confirmed ticket holder{{ recipientsCount !== 1 ? 's' : '' }}
            </span>
            <small class="d-block text-muted mt-1">
              Only confirmed ticket holders (with "Payment Confirmed" or "Ticket sent" status) will receive this email.
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Email Form -->
    <form #emailForm="ngForm" (ngSubmit)="sendEmail()">
      <!-- Subject Line -->
      <div class="row mb-3">
        <div class="col-12">
          <label for="emailSubject" class="form-label fw-bold">
            Subject Line <span class="text-danger">*</span>
          </label>
          <input
            type="text"
            id="emailSubject"
            name="emailSubject"
            class="form-control"
            [(ngModel)]="subject"
            placeholder="Enter email subject..."
            required
            maxlength="500"
            [disabled]="sending">
          <small class="form-text text-muted">
            <span [class]="subject.length > 400 ? 'text-warning' : 'text-muted'">
              {{ subject.length }}/500 characters
            </span>
            <span *ngIf="subject.length > 500" class="text-danger ms-2">
              <i class="fas fa-exclamation-triangle"></i> Too long!
            </span>
          </small>
        </div>
      </div>

      <!-- Banner Option -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="form-check">
            <input
              type="checkbox"
              id="includeBanner"
              name="includeBanner"
              class="form-check-input"
              [(ngModel)]="includeBanner"
              [disabled]="sending">
            <label for="includeBanner" class="form-check-label">
              Include email banner with event branding
            </label>
            <small class="form-text text-muted d-block">
              Adds a branded header with your label's logo and event title
            </small>
          </div>
        </div>
      </div>

      <!-- Message Editor -->
      <div class="row mb-4">
        <div class="col-12">
          <label for="emailMessage" class="form-label fw-bold">
            Message <span class="text-danger">*</span>
          </label>
          <quill-editor
            [(ngModel)]="message"
            name="emailMessage"
            [modules]="quillConfig"
            placeholder="Type your message here..."
            class="email-editor"
            [style]="{ 'min-height': '300px' }"
            [disabled]="sending">
          </quill-editor>
          <div class="form-text text-muted">
            <div class="mb-2">
              Use the toolbar above for rich text formatting, links, and images. Images will be automatically uploaded and included in the email.
              <br><strong>Image limits:</strong> Maximum 10 images, 5MB per image. Supported formats: JPEG, PNG, GIF, WebP.
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <span>
                <strong>Content size:</strong> 
                <span [class]="getContentSizeClass()">{{ getContentSizeText() }}</span>
              </span>
              <span *ngIf="isContentTooLarge()" class="text-danger">
                <i class="fas fa-exclamation-triangle"></i> Content too large!
              </span>
            </div>
          </div>
        </div>
      </div>

      </form>
    </div>

  <!-- No Event Selected -->
  <div class="text-center py-5" *ngIf="!selectedEvent">
    <i class="fas fa-envelope fa-4x text-muted mb-3"></i>
    <h5 class="text-muted">No Event Selected</h5>
    <p class="text-muted">Please select an event to send emails to ticket holders.</p>
  </div>
</div>

<!-- Sticky Bottom Panel - Outside all containers -->
<div class="sticky-bottom-panel" *ngIf="selectedEvent">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="panel-content">
          <div class="d-flex justify-content-between align-items-center w-100">
            <div class="text-muted">
              <small>
                <i class="fas fa-clock me-1"></i>
                Emails will be sent one by one to preserve deliverability
              </small>
            </div>
            <div class="d-flex gap-2">
              <button
                type="button"
                class="btn btn-outline-secondary"
                [disabled]="!isFormValid() || sending"
                (click)="showTestEmailModal()"
                title="Send a test email to specific addresses first">
                <i class="fas fa-flask me-2"></i>
                Send Test Email
              </button>
              <button
                type="button"
                class="btn btn-primary btn-lg"
                [disabled]="!isFormValid() || recipientsCount === 0 || sending || loadingCount"
                (click)="sendEmail()">
                <span *ngIf="sending" class="spinner-border spinner-border-sm me-2" role="status"></span>
                <i *ngIf="!sending" class="fas fa-paper-plane me-2"></i>
                <span *ngIf="sending">Sending Email...</span>
                <span *ngIf="!sending">Send Email to {{ recipientsCount }} Recipients</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Test Email Modal -->
<app-test-email-modal 
  #testEmailModal
  (testEmailConfirmed)="onTestEmailConfirmed($event)">
</app-test-email-modal>