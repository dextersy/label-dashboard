<div class="event-details-tab">  
  <!-- Draft Mode Info Box -->
  <div class="alert alert-info d-flex align-items-center mb-4" *ngIf="event && event.status === 'draft'">
    <i class="fa fa-info-circle me-3 fs-5"></i>
    <div>
      <strong>Draft Mode</strong> - This event is not yet visible to the public. 
      <span class="d-block small mt-1">
        Complete the event details and click "Publish" to make it live and generate ticket purchase links.
      </span>
    </div>
  </div>

  <form (ngSubmit)="onSaveEvent()" #eventForm="ngForm" *ngIf="event">
    <div class="row">
      <!-- General Information Column -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">General Information</h6>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label required">Title</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="event.title" 
                name="title"
                placeholder="Event Title"
                (input)="onTitleChange()"
                required>
            </div>

            <div class="mb-3">
              <label class="form-label required">Date & Time <span class="text-muted">(GMT+8 PH)</span></label>
              <input 
                type="datetime-local" 
                class="form-control" 
                [(ngModel)]="event.date_and_time" 
                name="date_and_time"
                required>
            </div>

            <div class="mb-3">
              <label class="form-label required">Venue</label>
              <app-venue-autocomplete
                placeholder="Search for venue or enter manually..."
                [required]="true"
                [hasError]="false"
                [ngModel]="currentVenueSelection"
                name="venue"
                (ngModelChange)="onVenueSelected($event)"
                (venueSelected)="onVenueSelected($event)">
              </app-venue-autocomplete>
            </div>

            <div class="mb-3">
              <label class="form-label required">RSVP or Social Media Link</label>
              <input 
                type="url" 
                class="form-control" 
                [(ngModel)]="event.rsvp_link" 
                name="rsvp_link"
                placeholder="https://facebook.com/events/..."
                required>
              <small class="form-text text-muted">
                <i class="fa fa-info-circle"></i> Add your Facebook event page link or preferred social media page. This will be included in tickets.
              </small>
            </div>

            <div class="mb-3" *ngIf="(!event.id || event.status === 'draft') && !event.buy_shortlink && !event.verification_link">
              <label class="form-label">URL Slug</label>
              <div class="input-group">
                <input 
                  type="text" 
                  class="form-control" 
                  [(ngModel)]="event.slug" 
                  name="slug"
                  placeholder="BuyMyAwesomeEvent"
                  [disabled]="event.status === 'published'">
                <button 
                  type="button" 
                  class="btn btn-outline-secondary"
                  (click)="generateSlug()"
                  [disabled]="event.status === 'published'"
                  title="Auto-generate from title">
                  <i class="fas fa-sync"></i>
                </button>
              </div>
              <small class="form-text text-muted">
                <i class="fa fa-info-circle"></i> 
                <span *ngIf="event.status === 'draft'">Custom URL path for shortened links. Leave empty to auto-generate from title when publishing.</span>
                <span *ngIf="event.status === 'published'">Slug cannot be changed after publishing.</span>
                <span *ngIf="!event.id">Custom URL path for shortened links. Leave empty to auto-generate from title when saving.</span>
              </small>
            </div>
          </div>
        </div>

        <!-- Event Poster Card -->
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">Event Poster</h6>
          </div>
          <div class="card-body">
            <div class="text-center mb-3">
              <img 
                [src]="event.poster_url || 'assets/img/placeholder.jpg'" 
                class="img-fluid poster-preview"
                alt="Event Poster"
                (error)="onImageError($event)"
                style="max-height: 300px; border-radius: 8px;">
            </div>
            
            <div class="mb-3">
              <label class="form-label">Upload New Poster</label>
              <input 
                type="file" 
                class="form-control" 
                accept="image/*"
                (change)="onFileSelected($event)"
                [disabled]="uploading">
              <small class="form-text text-muted">
                Upload an image file (max 10MB). JPG, PNG, GIF supported.
              </small>
              
              <!-- Poster Preview -->
              <div *ngIf="posterPreview" class="mt-3">
                <div class="d-flex align-items-center">
                  <img [src]="posterPreview" alt="New poster preview" class="img-thumbnail me-3" style="max-width: 150px; max-height: 150px;">
                  <div>
                    <p class="mb-2 text-success">
                      <i class="fa fa-check-circle me-1"></i>
                      New poster selected
                    </p>
                    <button type="button" class="btn btn-sm btn-outline-danger" (click)="removePoster()">
                      <i class="fa fa-times me-1"></i> Remove
                    </button>
                  </div>
                </div>
                <div class="alert alert-info mt-2 mb-0">
                  <small>
                    <i class="fa fa-info-circle me-1"></i>
                    Click "Save Changes" to upload this poster.
                  </small>
                </div>
              </div>
              
              <div *ngIf="uploading" class="mt-2">
                <div class="d-flex align-items-center">
                  <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                  <span class="text-muted">Uploading poster...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ticketing Column -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">
              Ticketing 
              <span class="badge ms-2" [class]="event.status === 'published' ? 'badge-success' : 'badge-secondary'">
                {{ event.status === 'published' ? 'Published' : 'Draft' }}
              </span>
              <span class="badge badge-secondary ms-1" *ngIf="event.status === 'published'" [class]="event.backend_status === 'Open' ? 'badge-success' : 'badge-danger'">
                {{ event.backend_status || 'Open' }}
              </span>
            </h6>
          </div>
          <div class="card-body">

            <!-- Ticket Types Management -->
            <app-ticket-types
              [selectedEvent]="selectedEvent"
              [isAdmin]="isAdmin"
              (alertMessage)="alertMessage.emit($event)"
              (ticketTypesChanged)="onTicketTypesChanged($event)">
            </app-ticket-types>

            <div class="row mt-3">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Maximum Number of Tickets</label>
                  <input 
                    type="number" 
                    class="form-control" 
                    [(ngModel)]="event.max_tickets" 
                    name="max_tickets"
                    placeholder="0"
                    min="0">
                  <small class="form-text text-muted">Set "0" for unlimited tickets or to use ticket type limits only.</small>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Close Ticket Sales On <span class="text-muted">(GMT+8 PH)</span></label>
                  <input 
                    type="datetime-local" 
                    class="form-control" 
                    [(ngModel)]="event.close_time" 
                    name="close_time">
                  <div class="mt-2 d-flex flex-wrap align-items-center" style="gap: 0.5rem;">
                    <small class="text-muted">Quick suggestions:</small>
                    <button 
                      type="button" 
                      class="btn btn-outline-secondary"
                      style="font-size: 0.7rem; padding: 0.15rem 0.4rem;"
                      (click)="setSuggestedCloseTime('4h')"
                      [disabled]="!event.date_and_time">
                      4h before
                    </button>
                    <button 
                      type="button" 
                      class="btn btn-outline-secondary"
                      style="font-size: 0.7rem; padding: 0.15rem 0.4rem;"
                      (click)="setSuggestedCloseTime('1d')"
                      [disabled]="!event.date_and_time">
                      1d before
                    </button>
                    <button 
                      type="button" 
                      class="btn btn-outline-secondary"
                      style="font-size: 0.7rem; padding: 0.15rem 0.4rem;"
                      (click)="setSuggestedCloseTime('2d')"
                      [disabled]="!event.date_and_time">
                      2d before
                    </button>
                    <button 
                      type="button" 
                      class="btn btn-outline-secondary"
                      style="font-size: 0.7rem; padding: 0.15rem 0.4rem;"
                      (click)="setSuggestedCloseTime('1w')"
                      [disabled]="!event.date_and_time">
                      1w before
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Show Countdown on Ticket Page</label>
                  <select 
                    class="form-control" 
                    [(ngModel)]="event.countdown_display" 
                    name="countdown_display">
                    <option value="always">Always show</option>
                    <option value="1_week">1 week before</option>
                    <option value="3_days">3 days before</option>
                    <option value="1_day">1 day before</option>
                    <option value="never">Never show</option>
                  </select>
                  <small class="form-text text-muted">
                    <i class="fa fa-info-circle"></i> Choose when to display a countdown timer on the ticket purchase page.
                  </small>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Ticket Purchase URL</label>
              <div class="input-group">
                <input 
                  type="text" 
                  class="form-control" 
                  [value]="event.buy_shortlink || (event.status === 'draft' ? 'Shortlinks will be generated once the event is published' : 'Save to generate buy link')" 
                  readonly>
                <button 
                  type="button" 
                  class="btn btn-outline-secondary"
                  (click)="copyToClipboard(event.buy_shortlink!, 'Buy link')"
                  [disabled]="!event.buy_shortlink">
                  <i class="fa fa-copy"></i>
                </button>
              </div>
              <small class="form-text text-muted">
                <span *ngIf="!event.buy_shortlink && event.status === 'draft'">This link will be generated when you publish the event.</span>
                <span *ngIf="event.buy_shortlink && event.status === 'draft'">Link generated from previous publish. Event is currently in draft mode.</span>
                <span *ngIf="event.status === 'published'">Share this link to ticket buyers.</span>
              </small>
            </div>

            <!-- Payment Methods -->
            <h6 class="mt-4">Payment Methods</h6>
            <div class="row">
              <div class="col-md-4">
                <div class="form-check form-switch mb-2">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [(ngModel)]="event.supports_gcash"
                    name="supports_gcash"
                    id="switchGCash">
                  <label class="form-check-label" for="switchGCash">GCash</label>
                </div>
                <div class="form-check form-switch mb-2">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [(ngModel)]="event.supports_qrph"
                    name="supports_qrph"
                    id="switchQRPH">
                  <label class="form-check-label" for="switchQRPH">QRPh</label>
                </div>
                <div class="form-check form-switch mb-2">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [(ngModel)]="event.supports_card"
                    name="supports_card"
                    id="switchCard">
                  <label class="form-check-label" for="switchCard">Credit Card</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check form-switch mb-2">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [(ngModel)]="event.supports_ubp"
                    name="supports_ubp"
                    id="switchUBP">
                  <label class="form-check-label" for="switchUBP">Unionbank Transfer</label>
                </div>
                <div class="form-check form-switch mb-2">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [(ngModel)]="event.supports_dob"
                    name="supports_dob"
                    id="switchDOB">
                  <label class="form-check-label" for="switchDOB">BPI</label>
                </div>
                <div class="form-check form-switch mb-2">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [(ngModel)]="event.supports_maya"
                    name="supports_maya"
                    id="switchMaya">
                  <label class="form-check-label" for="switchMaya">Maya</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-check form-switch mb-2">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    [(ngModel)]="event.supports_grabpay"
                    name="supports_grabpay"
                    id="switchGrabPay">
                  <label class="form-check-label" for="switchGrabPay">Grab Pay</label>
                </div>
              </div>
            </div>
            <small class="form-text text-muted">
              <i class="fa fa-info-circle"></i> Click 
              <a href="https://www.paymongo.com/pricing" target="_blank">here</a> 
              for information on processing fees for each payment method.
            </small>

            <!-- Verification Section -->
            <div class="mt-4">
              <div class="row">
                <div class="col-md-8">
                  <div class="mb-3">
                    <label class="form-label">Scanner URL</label>
                    <div class="input-group">
                      <input 
                        type="text" 
                        class="form-control" 
                        [value]="event.verification_link || (event.status === 'draft' ? 'Shortlinks will be generated once the event is published' : 'Save to generate scanner link')" 
                        readonly>
                      <button 
                        type="button" 
                        class="btn btn-outline-secondary"
                        (click)="copyToClipboard(event.verification_link!, 'Scanner link')"
                        [disabled]="!event.verification_link">
                        <i class="fa fa-copy"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label class="form-label">Scanner PIN</label>
                    <div class="input-group">
                      <input 
                        type="text" 
                        class="form-control" 
                        [value]="event.verification_pin" 
                        readonly>
                      <button 
                        type="button" 
                        class="btn btn-outline-secondary"
                        (click)="copyToClipboard(event.verification_pin, 'Scanner PIN')">
                        <i class="fa fa-copy"></i>
                      </button>
                      <button 
                        type="button" 
                        class="btn btn-outline-secondary"
                        (click)="resetPIN()"
                        [disabled]="!event.id || refreshingPIN"
                        [title]="!event.id ? 'Save event first to refresh PIN' : 'Refresh scanner PIN'">
                        <i class="fa" [class]="refreshingPIN ? 'fa-spinner fa-spin' : 'fa-sync'"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <small class="form-text text-muted">Share scanner link and PIN to gate staff.</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Event Description - Full Width -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">Event Description</h6>
          </div>
          <div class="card-body">
            <quill-editor 
              [(ngModel)]="event.description"
              name="description"
              [modules]="quillConfig"
              placeholder="Describe your event..."
              [style.height.px]="160">
            </quill-editor>
          </div>
        </div>
      </div>
    </div>

  </form>

  <!-- Read-only view for non-admin users -->
  <div class="alert alert-info" *ngIf="!isAdmin">
    <i class="fa fa-info-circle me-2"></i>
    You have read-only access to event details. Contact an administrator to make changes.
  </div>
</div>

<!-- Sticky Bottom Panel - Outside all containers -->
<div class="sticky-bottom-panel" *ngIf="event && isAdmin">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="panel-content d-flex gap-2">
          <!-- Draft Event Buttons -->
          <div *ngIf="event.status === 'draft'" class="d-flex gap-2">
            <button type="button" 
                    class="btn btn-secondary btn-lg" 
                    [disabled]="loading"
                    (click)="onSaveEvent()">
              <i class="fa fa-spinner fa-spin" *ngIf="loading"></i>
              <i class="fa fa-save" *ngIf="!loading"></i>
              {{ loading ? 'Saving...' : 'Save as Draft' }}
            </button>
            <button type="button" 
                    class="btn btn-success btn-lg" 
                    [disabled]="loading"
                    (click)="onPublishEvent()">
              <i class="fa fa-spinner fa-spin" *ngIf="loading"></i>
              <i class="fa fa-rocket" *ngIf="!loading"></i>
              {{ loading ? 'Publishing...' : 'Publish' }}
            </button>
          </div>

          <!-- Published Event Buttons -->
          <div *ngIf="event.status === 'published'" class="d-flex gap-2">
            <button type="button" 
                    class="btn btn-primary btn-lg" 
                    [disabled]="loading || !isFormDirty()"
                    (click)="onSaveEvent()">
              <i class="fa fa-spinner fa-spin" *ngIf="loading"></i>
              <i class="fa fa-save" *ngIf="!loading"></i>
              {{ loading ? 'Saving...' : 'Save Changes' }}
            </button>
            <button type="button" 
                    class="btn btn-warning btn-lg" 
                    [disabled]="loading"
                    (click)="onUnpublishEvent()"
                    *ngIf="!hasConfirmedTickets()">
              <i class="fa fa-spinner fa-spin" *ngIf="loading"></i>
              <i class="fa fa-eye-slash" *ngIf="!loading"></i>
              {{ loading ? 'Unpublishing...' : 'Unpublish' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>