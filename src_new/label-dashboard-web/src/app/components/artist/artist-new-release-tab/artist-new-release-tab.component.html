<div class="new-release-tab">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h4 class="title">
              <i class="fas fa-plus-circle"></i>
              {{ editingRelease ? 'Edit Release' : 'New Release' }}
            </h4>
          </div>
          <div class="card-body">
            <form [formGroup]="releaseForm" (ngSubmit)="onSubmit()">
              <div class="row">
                <!-- Left Column -->
                <div class="col-md-6">
                  <!-- Cover Art -->
                  <div class="form-group">
                    <label for="cover_art">Cover Art</label>
                    <div class="cover-art-section">
                      <div class="current-cover" *ngIf="coverArtPreview">
                        <img [src]="coverArtPreview" alt="Cover Art Preview" class="cover-preview">
                      </div>
                      <input type="file" 
                             class="form-control" 
                             id="cover_art" 
                             accept=".jpg,.jpeg,.png"
                             (change)="onCoverArtSelected($event)">
                      <small class="form-text text-muted">
                        Accepted formats: JPG, PNG. Maximum size: 5MB
                      </small>
                    </div>
                  </div>

                  <!-- Title -->
                  <div class="form-group">
                    <label for="title">Title *</label>
                    <input type="text" 
                           class="form-control"
                           [class.is-invalid]="isFieldInvalid('title')"
                           id="title" 
                           formControlName="title" 
                           placeholder="Release Title">
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('title')">
                      {{ getFieldError('title') }}
                    </div>
                  </div>

                  <!-- Catalog Number -->
                  <div class="form-group">
                    <label for="catalog_no">Catalog Number *</label>
                    <input type="text" 
                           class="form-control"
                           [class.is-invalid]="isFieldInvalid('catalog_no')"
                           id="catalog_no" 
                           formControlName="catalog_no" 
                           placeholder="Catalog Number">
                    <small class="form-text text-muted">
                      Default is auto-generated
                    </small>
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('catalog_no')">
                      {{ getFieldError('catalog_no') }}
                    </div>
                  </div>

                  <!-- Liner Notes -->
                  <div class="form-group">
                    <label for="liner_notes">Liner Notes</label>
                    <small class="form-text text-muted mb-2">
                      Please add your liner notes, acknowledgments, or credits. This will appear on the release page on the website and on Bandcamp. 
                      It will NOT appear on Spotify, Apple Music, or other streaming platforms.<br>
                      <strong>Suggestion:</strong> Mention the cover art designer, producer, mixing and mastering, any additional musicians, and the studio where you recorded it.
                    </small>
                    <textarea class="form-control" 
                              id="liner_notes" 
                              formControlName="liner_notes" 
                              rows="8"
                              placeholder="Liner notes, acknowledgments, credits..."></textarea>
                  </div>
                </div>

                <!-- Right Column -->
                <div class="col-md-6">
                  <!-- UPC -->
                  <div class="form-group">
                    <label for="UPC">UPC/EAN Code</label>
                    <input type="text" 
                           class="form-control" 
                           id="UPC" 
                           formControlName="UPC" 
                           placeholder="UPC/EAN code">
                  </div>

                  <!-- Release Date -->
                  <div class="form-group">
                    <label for="release_date">Release Date *</label>
                    <input type="date" 
                           class="form-control"
                           [class.is-invalid]="isFieldInvalid('release_date')"
                           id="release_date" 
                           formControlName="release_date">
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('release_date')">
                      {{ getFieldError('release_date') }}
                    </div>
                  </div>

                  <!-- Status (Admin only) -->
                  <div class="form-group" *ngIf="isAdmin">
                    <label for="status">Status</label>
                    <select class="form-control" id="status" formControlName="status">
                      <option value="Pending">Pending</option>
                      <option value="Live">Live</option>
                      <option value="Taken Down">Taken Down</option>
                    </select>
                  </div>

                  <!-- Description -->
                  <div class="form-group">
                    <label for="description">Tell us about this release</label>
                    <small class="form-text text-muted mb-2">
                      Give us a quick statement about the release, indicating what the song is about, the musical approach, 
                      production stories, and any future plans related to the song. We will use this to craft our pitch to 
                      playlists as well as for our press releases. Feel free to give us a bullet list or just a rough statement.
                    </small>
                    <textarea class="form-control" 
                              id="description" 
                              formControlName="description" 
                              rows="8"
                              placeholder="Description of the release, musical approach, stories..."></textarea>
                  </div>
                </div>
              </div>

              <!-- Royalty Splits (Admin Only) -->
              <div *ngIf="isAdmin" class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                  <h5 class="mb-0">Royalty Splits</h5>
                  <button type="button" 
                          class="btn btn-outline-primary btn-sm"
                          (click)="addRoyaltyArtist()"
                          [disabled]="loadingArtists">
                    <i class="fas fa-plus"></i>
                    Add Artist
                  </button>
                </div>
                
                <div *ngIf="loadingArtists" class="text-center py-3">
                  <i class="fas fa-spinner fa-spin"></i>
                  Loading artists...
                </div>
                
                <div class="table-responsive" *ngIf="!loadingArtists">
                  <table class="table table-bordered">
                    <thead>
                      <tr>
                        <th width="30%">Artist</th>
                        <th width="15%">Sync Royalty</th>
                        <th width="15%">Download Royalty</th>
                        <th width="15%">Streaming Royalty</th>
                        <th width="15%">Physical Royalty</th>
                        <th width="10%">Actions</th>
                      </tr>
                    </thead>
                    <tbody formArrayName="royaltyArtists">
                      <tr *ngFor="let artistControl of royaltyArtists.controls; let i = index" [formGroupName]="i">
                        <td>
                          <select class="form-control form-control-sm" 
                                  formControlName="artist_id"
                                  [class.is-invalid]="artistControl.get('artist_id')?.invalid && artistControl.get('artist_id')?.touched">
                            <option value="">Select Artist</option>
                            <option *ngFor="let availableArtist of getAvailableArtists(i)" 
                                    [value]="availableArtist.id">
                              {{ availableArtist.name }}
                            </option>
                          </select>
                          <div class="invalid-feedback" *ngIf="artistControl.get('artist_id')?.invalid && artistControl.get('artist_id')?.touched">
                            Please select an artist
                          </div>
                        </td>
                        <td>
                          <div class="input-group">
                            <input type="number" 
                                   class="form-control form-control-sm" 
                                   formControlName="sync_royalty_percentage"
                                   min="0" 
                                   max="100" 
                                   step="1">
                            <div class="input-group-append">
                              <span class="input-group-text">%</span>
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="input-group">
                            <input type="number" 
                                   class="form-control form-control-sm" 
                                   formControlName="download_royalty_percentage"
                                   min="0" 
                                   max="100" 
                                   step="1">
                            <div class="input-group-append">
                              <span class="input-group-text">%</span>
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="input-group">
                            <input type="number" 
                                   class="form-control form-control-sm" 
                                   formControlName="streaming_royalty_percentage"
                                   min="0" 
                                   max="100" 
                                   step="1">
                            <div class="input-group-append">
                              <span class="input-group-text">%</span>
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="input-group">
                            <input type="number" 
                                   class="form-control form-control-sm" 
                                   formControlName="physical_royalty_percentage"
                                   min="0" 
                                   max="100" 
                                   step="1">
                            <div class="input-group-append">
                              <span class="input-group-text">%</span>
                            </div>
                          </div>
                        </td>
                        <td class="text-center">
                          <button type="button" 
                                  class="btn btn-outline-danger btn-sm"
                                  (click)="removeRoyaltyArtist(i)"
                                  [disabled]="royaltyArtists.length <= 1"
                                  title="Remove Artist">
                            <i class="fas fa-trash"></i>
                          </button>
                        </td>
                      </tr>
                      <tr *ngIf="royaltyArtists.length === 0">
                        <td colspan="6" class="text-center text-muted py-3">
                          <i class="fas fa-info-circle"></i>
                          No artists added yet. Click "Add Artist" to get started.
                        </td>
                      </tr>
                    </tbody>
                    <tfoot *ngIf="royaltyArtists.length > 0">
                      <tr class="table-secondary">
                        <th class="text-left">
                          <strong>Label receives</strong>
                        </th>
                        <th>
                          <span [class]="getRoyaltyTotal('sync') > 100 ? 'text-danger' : 'text-success'">
                            {{ getLabelRoyalty('sync') }}%
                          </span>
                        </th>
                        <th>
                          <span [class]="getRoyaltyTotal('download') > 100 ? 'text-danger' : 'text-success'">
                            {{ getLabelRoyalty('download') }}%
                          </span>
                        </th>
                        <th>
                          <span [class]="getRoyaltyTotal('streaming') > 100 ? 'text-danger' : 'text-success'">
                            {{ getLabelRoyalty('streaming') }}%
                          </span>
                        </th>
                        <th>
                          <span [class]="getRoyaltyTotal('physical') > 100 ? 'text-danger' : 'text-success'">
                            {{ getLabelRoyalty('physical') }}%
                          </span>
                        </th>
                        <th></th>
                      </tr>
                    </tfoot>
                  </table>
                </div>
                
                <!-- Royalty Split Notes -->
                <div class="mt-3" *ngIf="royaltyArtists.length > 0">
                  <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    <strong>Note:</strong> Artist percentages for each royalty type should not exceed 100%. 
                    The label row shows the remaining percentage (100% - total artist percentages).
                  </small>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="row mt-4">
                <div class="col-md-6">
                  <button type="submit" 
                          class="btn btn-primary btn-block"
                          [disabled]="loading || releaseForm.invalid">
                    <i class="fas fa-save" *ngIf="!loading"></i>
                    <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
                    {{ loading ? 'Saving...' : (editingRelease ? 'Update Release' : 'Save Release') }}
                  </button>
                </div>
                <div class="col-md-6">
                  <button type="button" 
                          class="btn btn-secondary btn-block"
                          [disabled]="loading"
                          (click)="onCancel()">
                    Cancel
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>