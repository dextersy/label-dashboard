<div class="row">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h5>Add New Payment</h5>
      </div>
      <div class="card-body">
        <form (ngSubmit)="onSubmitPayment()">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label>Date Paid</label>
                <input type="date" class="form-control" [(ngModel)]="newPaymentForm.date_paid" name="date_paid" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Amount (PHP)</label>
                <input type="number" class="form-control" [(ngModel)]="newPaymentForm.amount" name="amount" min="0" step="0.01" placeholder="0.00" required>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label>Description</label>
            <input type="text" class="form-control" [(ngModel)]="newPaymentForm.description" name="description" placeholder="Enter payment description" required>
          </div>
          
          <div class="form-group">
            <label>Paid through</label>
            <select class="form-control" [(ngModel)]="selectedPaymentMethodId" (change)="onPaymentMethodChange($event)" name="paymentMethodSelect" required>
              <option value="">Select payment method</option>
              <option value="-1">Non-cash / adjustment</option>
              <option *ngFor="let method of paymentMethods" [value]="method.id">
                {{method.type}} - {{method.account_name}} - {{method.account_number_or_email}}
              </option>
            </select>
          </div>

          <!-- Offline Payment Checkbox - Hidden when non-cash is selected -->
          <div class="form-group" *ngIf="shouldShowOfflineCheckbox()">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" [(ngModel)]="isManualPayment" name="manualPayment" (change)="toggleManualPayment()">
              <label class="form-check-label">
                This is an offline payment.
              </label>
            </div>
          </div>

          <!-- Non-cash Selection Message -->
          <div class="alert alert-secondary" *ngIf="isNonCashSelected()">
            <i class="fa fa-info-circle"></i> Non-cash payments are automatically processed as offline payments.
          </div>

          <!-- Wallet Balance Display -->
          <div *ngIf="shouldShowWalletBalance()" class="alert" [class.alert-info]="!isInsufficientBalance()" [class.alert-warning]="isInsufficientBalance()">
            <div class="d-flex justify-content-between align-items-center">
              <span><i class="fa fa-credit-card"></i> Available Wallet Balance:</span>
              <strong>{{ formatCurrency(walletBalance) }}</strong>
            </div>
            <small class="text-muted" *ngIf="!isInsufficientBalance()">This payment will be processed through Paymongo wallet.</small>
            <small class="text-warning" *ngIf="isInsufficientBalance()">
              <i class="fa fa-exclamation-triangle"></i> Insufficient wallet balance. Payment amount exceeds available balance.
            </small>
          </div>

          <div *ngIf="newPaymentForm.manualPayment === '1'">
            <div class="form-group">
              <label>Reference Number</label>
              <input type="text" class="form-control" [(ngModel)]="newPaymentForm.reference_number" name="reference_number" placeholder="Reference Number">
            </div>
            <div class="form-group">
              <label>Processing Fee (PHP)</label>
              <div class="input-group">
                <div class="input-group-addon">â‚±</div>
                <input type="number" class="form-control" [(ngModel)]="newPaymentForm.payment_processing_fee" name="payment_processing_fee" min="0" step="0.01" placeholder="0.00" value="0">
              </div>
            </div>
          </div>

          <!-- Hidden fields for payment method details (populated automatically) -->
          <input type="hidden" [(ngModel)]="newPaymentForm.paid_thru_type" name="paid_thru_type">
          <input type="hidden" [(ngModel)]="newPaymentForm.paid_thru_account_name" name="paid_thru_account_name">
          <input type="hidden" [(ngModel)]="newPaymentForm.paid_thru_account_number" name="paid_thru_account_number">
          <input type="hidden" [(ngModel)]="newPaymentForm.payment_method_id" name="payment_method_id">
          
          <div class="text-right">
            <button type="submit" class="btn btn-success" [disabled]="isSubmittingPayment">
              <span *ngIf="isSubmittingPayment" class="spinner-border spinner-border-sm me-1" role="status"></span>
              <i *ngIf="!isSubmittingPayment" class="fa fa-plus"></i> 
              {{ isSubmittingPayment ? 'Adding Payment...' : 'Add Payment' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>