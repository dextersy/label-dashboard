<div class="child-brands-tab">
  <app-breadcrumb></app-breadcrumb>
  <!-- Date Range Filter -->
  <app-date-range-filter
    [loading]="loading"
    [compact]="true"
    (dateRangeChange)="onDateRangeChange($event)"
    (refresh)="onRefreshData()">
  </app-date-range-filter>

  <app-paginated-table
    title="Sublabels"
    [data]="sortedChildBrands"
    [columns]="tableColumns"
    [loading]="loading"
    [pagination]="pagination"
    [showSearch]="true"
    [showSortableHeaders]="true"
    [actions]="sublabelActions"
    [sortInfo]="sortInfo"
    (sortChange)="onSortChange($event)"
    (breakdownButtonClick)="onBreakdownButtonClick($event)">

    <ng-template #customButtons>
      <button *ngIf="isSuperAdmin()"
              class="btn btn-primary btn-sm"
              (click)="openAddSublabelModal()"
              [disabled]="loading || isAnyPollingInProgress()"
              [title]="getAddSublabelButtonTooltip()">
        <span *ngIf="!isAnyPollingInProgress()">
          <i class="fas fa-plus"></i> Add
        </span>
        <span *ngIf="sublabelCreationState.inProgress">
          <i class="fas fa-spinner fa-spin"></i> Creating {{ sublabelCreationState.pendingName }}...
        </span>
        <span *ngIf="domainVerificationState.inProgress && !sublabelCreationState.inProgress">
          <i class="fas fa-spinner fa-spin"></i> Verifying {{ domainVerificationState.pendingDomain }}...
        </span>
      </button>
    </ng-template>
  </app-paginated-table>
</div>

<!-- Sticky Summary Cards - Outside main container -->
<div class="summary-cards-sticky" *ngIf="!loading && childBrands.length > 0">
  <div class="container-fluid">
    <div class="row">
    <div class="col-md-6 col-lg">
      <div class="card summary-card">
        <div class="card-body text-center">
          <h4 class="card-title text-primary" [ngClass]="getAmountClass(getTotalBalance())">₱{{ getTotalBalance() | number:'1.2-2' }}</h4>
          <p class="card-text text-muted">Total Balance</p>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg">
      <div class="card summary-card">
        <div class="card-body text-center">
          <h4 class="card-title text-info" [ngClass]="getAmountClass(getTotalMusicEarnings())">₱{{ getTotalMusicEarnings() | number:'1.2-2' }}</h4>
          <p class="card-text text-muted">Total Music Earnings</p>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg">
      <div class="card summary-card clickable-card" (click)="openTotalEventBreakdown()" style="cursor: pointer;">
        <div class="card-body text-center">
          <h4 class="card-title text-warning" [ngClass]="getAmountClass(getTotalEventEarnings())">₱{{ getTotalEventEarnings() | number:'1.2-2' }}</h4>
          <p class="card-text text-muted">
            Total Event Earnings
            <i class="fas fa-info-circle ms-1" style="font-size: 0.8em;"></i>
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg">
      <div class="card summary-card">
        <div class="card-body text-center">
          <h4 class="card-title text-danger" [ngClass]="getAmountClass(getTotalFundraiserEarnings())">₱{{ getTotalFundraiserEarnings() | number:'1.2-2' }}</h4>
          <p class="card-text text-muted">Total Fundraiser Earnings</p>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg">
      <div class="card summary-card">
        <div class="card-body text-center">
          <h4 class="card-title text-secondary" [ngClass]="getAmountClass(getTotalPayments())">₱{{ getTotalPayments() | number:'1.2-2' }}</h4>
          <p class="card-text text-muted">Total Payments Made</p>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg">
      <div class="card summary-card">
        <div class="card-body text-center">
          <h4 class="card-title text-dark" [ngClass]="getAmountClass(getTotalPlatformFees())">₱{{ getTotalPlatformFees() | number:'1.2-2' }}</h4>
          <p class="card-text text-muted">Total Platform Fees</p>
        </div>
      </div>
    </div>

    </div>
  </div>
</div>

<!-- Add Sublabel Modal -->
<app-add-sublabel-modal
  [show]="showAddSublabelModal"
  (close)="closeAddSublabelModal()"
  (submit)="onCreateSublabel($event)">
</app-add-sublabel-modal>

<!-- Fee Settings Modal -->
<app-fee-settings-modal
  [show]="showFeeSettingsModal"
  [brandId]="selectedSublabelForFees?.brand_id || null"
  [sublabelName]="selectedSublabelForFees?.brand_name || ''"
  (close)="closeFeeSettingsModal()"
  (saved)="onFeeSettingsSaved($event)">
</app-fee-settings-modal>

<!-- Payout Modal -->
<app-sublabel-payout-modal
  #payoutModal
  [show]="showPayoutModal"
  [sublabel]="selectedSublabelForPayout"
  (close)="closePayoutModal()"
  (submit)="onPayoutSubmit($event)">
</app-sublabel-payout-modal>

<!-- Earnings Breakdown Modal -->
<app-earnings-breakdown-modal
  [show]="showEarningsBreakdownModal"
  [childBrand]="selectedSublabelForBreakdown"
  [aggregatedTotals]="aggregatedTotalsForBreakdown"
  [breakdownType]="earningsBreakdownType"
  (close)="closeEarningsBreakdownModal()">
</app-earnings-breakdown-modal>

<!-- Sublabel Payments Modal -->
<app-sublabel-payments-modal
  [show]="showPaymentsModal"
  [brandId]="selectedSublabelForPayments?.brand_id || null"
  [brandName]="selectedSublabelForPayments?.brand_name || ''"
  (close)="closePaymentsModal()">
</app-sublabel-payments-modal>