<div class="label-finance-tab">
  <!-- Date Range Filter -->
  <div class="row mb-4">
    <div class="col-md-12">
      <app-date-range-filter
        [compact]="true"
        [loading]="loading"
        [initialPreset]="'alltime'"
        (dateRangeChange)="onDateRangeChanged($event)"
        (refresh)="onRefresh()">
      </app-date-range-filter>
    </div>
  </div>

  <!-- Dashboard Metrics -->
  <div class="row mb-4">
    <div class="col-lg col-md-6 mb-3 mb-lg-0">
      <div class="current-balance-section text-center p-4 h-100">
        <h2 class="balance-title">Receivable Balance</h2>
        <h1 class="balance-amount" [ngClass]="getAmountClass(dashboard?.receivable_balance ?? 0)">₱{{ (dashboard?.receivable_balance ?? 0) | number:'1.2-2' }}</h1>
        <p class="balance-subtitle">Net earnings - payments received</p>
      </div>
    </div>

    <div class="col-lg col-md-6 mb-3 mb-lg-0">
      <div class="card text-center financial-card h-100">
        <div class="card-body">
          <h3 class="card-title">Net Music Earnings</h3>
          <h2 [ngClass]="getAmountClass(dashboard?.net_music_earnings ?? 0)">₱{{ (dashboard?.net_music_earnings ?? 0) | number:'1.2-2' }}</h2>
          <button class="btn btn-outline-secondary btn-block w-100" (click)="showBreakdown('music')">
            View Details
          </button>
        </div>
      </div>
    </div>

    <div class="col-lg col-md-6 mb-3 mb-lg-0">
      <div class="card text-center financial-card h-100">
        <div class="card-body">
          <h3 class="card-title">Net Event Earnings</h3>
          <h2 [ngClass]="getAmountClass(dashboard?.net_event_earnings ?? 0)">₱{{ (dashboard?.net_event_earnings ?? 0) | number:'1.2-2' }}</h2>
          <button class="btn btn-outline-secondary btn-block w-100" (click)="showBreakdown('event')">
            View Details
          </button>
        </div>
      </div>
    </div>

    <div class="col-lg col-md-6 mb-3 mb-lg-0">
      <div class="card text-center financial-card h-100">
        <div class="card-body">
          <h3 class="card-title">Net Fundraiser Earnings</h3>
          <h2 [ngClass]="getAmountClass(dashboard?.net_fundraiser_earnings ?? 0)">₱{{ (dashboard?.net_fundraiser_earnings ?? 0) | number:'1.2-2' }}</h2>
          <button class="btn btn-outline-secondary btn-block w-100" (click)="showBreakdown('fundraiser')">
            View Details
          </button>
        </div>
      </div>
    </div>

    <div class="col-lg col-md-6 mb-3 mb-lg-0">
      <div class="card text-center financial-card h-100">
        <div class="card-body">
          <h3 class="card-title">Total Payments</h3>
          <h2 [ngClass]="getAmountClass(dashboard?.total_payments ?? 0)">₱{{ (dashboard?.total_payments ?? 0) | number:'1.2-2' }}</h2>
          <p class="text-muted small">Payments received</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Methods Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Payment Methods</h5>
          <button class="btn btn-primary" (click)="openAddPaymentMethodModal()">
            <i class="fas fa-plus me-1"></i>Add Payment Method
          </button>
        </div>
        <div class="card-body">
          <div *ngIf="!paymentMethods || paymentMethods.length === 0" class="text-center text-muted">
            <i class="fas fa-credit-card fa-3x mb-3"></i>
            <p>No payment methods configured yet.</p>
            <button class="btn btn-primary" (click)="openAddPaymentMethodModal()">
              <i class="fas fa-plus me-1"></i>Add Your First Payment Method
            </button>
          </div>
          <div *ngIf="paymentMethods && paymentMethods.length > 0">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Account Name</th>
                    <th>Account Number/Email</th>
                    <th>Bank Code</th>
                    <th>Default</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let method of paymentMethods">
                    <td>{{ method.type }}</td>
                    <td>{{ method.account_name }}</td>
                    <td>{{ method.account_number_or_email }}</td>
                    <td>{{ method.bank_code || 'N/A' }}</td>
                    <td>
                      <span *ngIf="method.is_default_for_brand" class="badge bg-success">Default</span>
                      <span *ngIf="!method.is_default_for_brand" class="text-muted">-</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Payments List Section -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Payment History</h5>
        </div>
        <div class="card-body">
          <div *ngIf="payments.length === 0" class="text-center text-muted">
            <i class="fas fa-money-bill-wave fa-3x mb-3"></i>
            <p>No payments recorded yet.</p>
          </div>
          <div *ngIf="payments.length > 0">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Payment Method</th>
                    <th>Reference</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let payment of payments">
                    <td>{{ payment.date_paid | date:'MMM dd, yyyy' }}</td>
                    <td>{{ payment.description || 'Payment received' }}</td>
                    <td [ngClass]="getAmountClass(payment.amount)">₱{{ payment.amount | number:'1.2-2' }}</td>
                    <td>{{ formatPaymentMethod(payment) }}</td>
                    <td>{{ payment.reference_number || 'N/A' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- Pagination -->
            <nav *ngIf="paymentsResponse?.pagination && (paymentsResponse?.pagination?.total_pages || 0) > 1">
              <ul class="pagination justify-content-center">
                <li class="page-item" [class.disabled]="!paymentsResponse?.pagination?.has_prev">
                  <button class="page-link" (click)="loadPayments((paymentsResponse?.pagination?.current_page || 1) - 1)" 
                          [disabled]="!paymentsResponse?.pagination?.has_prev">Previous</button>
                </li>
                <li class="page-item" *ngFor="let page of getPageNumbers()" 
                    [class.active]="page === paymentsResponse?.pagination?.current_page">
                  <button class="page-link" (click)="loadPayments(page)">{{ page }}</button>
                </li>
                <li class="page-item" [class.disabled]="!paymentsResponse?.pagination?.has_next">
                  <button class="page-link" (click)="loadPayments((paymentsResponse?.pagination?.current_page || 1) + 1)"
                          [disabled]="!paymentsResponse?.pagination?.has_next">Next</button>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Breakdown Modal -->
  <div class="modal fade show" appModalToBody *ngIf="showBreakdownModal" tabindex="-1" style="display: block;">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            {{ breakdownType === 'music' ? 'Music Earnings' : (breakdownType === 'event' ? 'Event Earnings' : 'Fundraiser Earnings') }} Breakdown
          </h5>
          <button type="button" class="btn-close" (click)="closeBreakdownModal()"></button>
        </div>
        <div class="modal-body">
          <div *ngIf="breakdown?.breakdown && (breakdown?.breakdown?.length || 0) > 0">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <ng-container *ngIf="breakdownType === 'music'">
                      <th>Release</th>
                      <th>Gross Earnings</th>
                      <th>Royalties</th>
                      <th>Platform Fees</th>
                      <th>Net Earnings</th>
                    </ng-container>
                    <ng-container *ngIf="breakdownType === 'event'">
                      <th>Event</th>
                      <th>Sales</th>
                      <th>Platform Fees</th>
                      <th>Processing Fees</th>
                      <th>Net Earnings</th>
                    </ng-container>
                    <ng-container *ngIf="breakdownType === 'fundraiser'">
                      <th>Fundraiser</th>
                      <th>Gross Donations</th>
                      <th>Platform Fees</th>
                      <th>Processing Fees</th>
                      <th>Net Earnings</th>
                    </ng-container>
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngFor="let item of breakdown?.breakdown || []">
                    <tr>
                      <ng-container *ngIf="breakdownType === 'music'">
                        <td>{{ item.release_title }}</td>
                        <td [ngClass]="getAmountClass(item.gross_earnings)">₱{{ item.gross_earnings | number:'1.2-2' }}</td>
                        <td [ngClass]="getAmountClass(item.royalties)">₱{{ item.royalties | number:'1.2-2' }}</td>
                        <td [ngClass]="getAmountClass(item.platform_fees)">₱{{ item.platform_fees | number:'1.2-2' }}</td>
                        <td [ngClass]="getAmountClass(item.net_earnings)">₱{{ item.net_earnings | number:'1.2-2' }}</td>
                      </ng-container>
                      <ng-container *ngIf="breakdownType === 'event'">
                        <td>{{ item.event_name }}</td>
                        <td [ngClass]="getAmountClass(item.sales)">₱{{ item.sales | number:'1.2-2' }}</td>
                        <td [ngClass]="getAmountClass(item.platform_fees)">₱{{ item.platform_fees | number:'1.2-2' }}</td>
                        <td [ngClass]="getAmountClass(item.processing_fees)">₱{{ item.processing_fees | number:'1.2-2' }}</td>
                        <td [ngClass]="getAmountClass(item.net_earnings)">₱{{ item.net_earnings | number:'1.2-2' }}</td>
                      </ng-container>
                      <ng-container *ngIf="breakdownType === 'fundraiser'">
                        <td>{{ item.fundraiser_name }}</td>
                        <td [ngClass]="getAmountClass(item.gross_earnings)">₱{{ item.gross_earnings | number:'1.2-2' }}</td>
                        <td [ngClass]="getAmountClass(item.platform_fees)">₱{{ item.platform_fees | number:'1.2-2' }}</td>
                        <td [ngClass]="getAmountClass(item.processing_fees)">₱{{ item.processing_fees | number:'1.2-2' }}</td>
                        <td [ngClass]="getAmountClass(item.net_earnings)">₱{{ item.net_earnings | number:'1.2-2' }}</td>
                      </ng-container>
                    </tr>
                  </ng-container>
                </tbody>
              </table>
            </div>
          </div>
          <div *ngIf="!breakdown?.breakdown || (breakdown?.breakdown?.length || 0) === 0" class="text-center text-muted">
            <p>No {{ breakdownType }} data available for the selected date range.</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeBreakdownModal()">Close</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show" appModalToBody *ngIf="showBreakdownModal"></div>

  <!-- Add Payment Method Modal -->
  <div class="modal fade show" appModalToBody *ngIf="showAddPaymentMethodModal" tabindex="-1" style="display: block;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Payment Method</h5>
          <button type="button" class="btn-close" (click)="closeAddPaymentMethodModal()"></button>
        </div>
        <div class="modal-body">
          <form #addPaymentMethodForm="ngForm" (ngSubmit)="addPaymentMethod()">
            <div class="mb-3">
              <label class="form-label">Bank Selection *</label>
              <select class="form-control" name="bank_selection" [(ngModel)]="newPaymentMethod.bank_selection" required>
                <option value="">Select Bank</option>
                <option *ngFor="let bank of supportedBanks" [value]="bank.bank_code + ',' + bank.bank_name">
                  {{ bank.bank_name }}
                </option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Account Name *</label>
              <input type="text" class="form-control" name="account_name"
                     [(ngModel)]="newPaymentMethod.account_name" required
                     placeholder="Enter account holder name">
            </div>

            <div class="mb-3">
              <label class="form-label">Account Number/Email *</label>
              <input type="text" class="form-control" name="account_number_or_email"
                     [(ngModel)]="newPaymentMethod.account_number_or_email" required
                     placeholder="Enter account number or email">
            </div>

            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="is_default_for_brand"
                     [(ngModel)]="newPaymentMethod.is_default_for_brand">
              <label class="form-check-label">Set as default payment method</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeAddPaymentMethodModal()">Cancel</button>
          <button type="button" class="btn btn-primary"
                  [disabled]="!addPaymentMethodForm?.form?.valid"
                  (click)="addPaymentMethod()">
            Add Payment Method
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show" appModalToBody *ngIf="showAddPaymentMethodModal"></div>
</div>