<div class="event-form-page">
  <!-- Event Selection (only in edit mode) -->
  <app-event-selection
    *ngIf="!isNewEvent"
    [events]="availableEvents"
    [selectedEvent]="event"
    [loading]="loading"
    [isAdmin]="isAdmin"
    (eventSelected)="onEventSelection($event)">
  </app-event-selection>

  <app-breadcrumb></app-breadcrumb>

  <div class="event-form-layout">
    <!-- Sidebar Navigation (Desktop) / Top Navigation (Mobile) -->
    <nav class="event-form-sidebar">
      <div class="sidebar-items">
        <button 
          type="button"
          class="sidebar-item"
          [class.active]="activeSection === 'general'"
          (click)="setActiveSection('general')">
          <i class="fa fa-info-circle"></i>
          <span>General Information</span>
        </button>
        <button 
          type="button"
          class="sidebar-item"
          [class.active]="activeSection === 'purchase'"
          (click)="setActiveSection('purchase')">
          <i class="fa fa-shopping-cart"></i>
          <span>Ticket Purchase</span>
        </button>
        <button 
          type="button"
          class="sidebar-item"
          [class.active]="activeSection === 'ticket-types'"
          (click)="setActiveSection('ticket-types')">
          <i class="fa fa-ticket"></i>
          <span>Ticket Types</span>
        </button>
        <button 
          type="button"
          class="sidebar-item"
          [class.active]="activeSection === 'scanner'"
          (click)="setActiveSection('scanner')">
          <i class="fa fa-qrcode"></i>
          <span>Scanner</span>
        </button>
      </div>
    </nav>

    <!-- Main Content Area -->
    <div class="event-form-main">
      <div class="event-form-container">
        <!-- Loading State -->
        <div *ngIf="loading" class="loading-container">
          <div class="loading-dots">
            <div></div>
            <div></div>
            <div></div>
          </div>
        </div>

        <!-- Form Content -->
        <div *ngIf="!loading" class="event-form-content">
          <!-- General Information Section -->
          <div class="form-section" *ngIf="activeSection === 'general'">
            <h3>General Information</h3>
            <p>Basic event details and description</p>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label required">Event Title</label>
                <input 
                  type="text" 
                  class="form-control" 
                  [(ngModel)]="eventData.title"
                  (input)="onTitleChange()"
                  placeholder="Enter event title"
                  required>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label required">Event Date & Time <span class="text-muted">(GMT+8 PH)</span></label>
                <input 
                  type="datetime-local" 
                  class="form-control" 
                  [(ngModel)]="eventData.date_and_time"
                  required>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label required">Venue</label>
                <app-venue-autocomplete
                  placeholder="Search for venue or enter manually..."
                  [required]="true"
                  [hasError]="false"
                  [ngModel]="currentVenueSelection"
                  (ngModelChange)="onVenueSelected($event)"
                  (venueSelected)="onVenueSelected($event)">
                </app-venue-autocomplete>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label required">RSVP or Social Media Link</label>
                <input 
                  type="url" 
                  class="form-control" 
                  [(ngModel)]="eventData.rsvp_link"
                  placeholder="https://facebook.com/events/..."
                  required>
                <small class="form-text text-muted">
                  <i class="fa fa-info-circle"></i> Facebook event page link or preferred social media page
                </small>
              </div>

              <div class="col-12 mb-3" *ngIf="isEventDraft()">
                <label class="form-label">URL Slug</label>
                <div class="input-group">
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="eventData.slug"
                    (input)="onSlugChange()"
                    placeholder="BuyMyAwesomeEvent">
                  <button 
                    type="button" 
                    class="btn btn-outline-secondary"
                    (click)="generateSlug()"
                    title="Auto-generate from title">
                    <i class="fas fa-sync"></i>
                  </button>
                </div>
                <small class="form-text text-muted">
                  <i class="fa fa-info-circle"></i> Custom URL path for shortened links. Auto-generated from title if left empty.
                </small>
              </div>

              <div class="col-12 mb-3">
                <label class="form-label">Description</label>
                <quill-editor 
                  [(ngModel)]="eventData.description"
                  [modules]="quillConfig"
                  placeholder="Enter event description...">
                </quill-editor>
              </div>

              <div class="col-12 mb-3">
                <label class="form-label">Event Poster</label>
                <div *ngIf="!posterPreview && !eventData.poster_url" class="poster-upload-zone" (click)="posterInput.click()">
                  <i class="fa fa-image fa-3x text-muted mb-2"></i>
                  <p class="text-muted mb-0">Click to upload poster image</p>
                  <small class="text-muted">JPG, PNG or GIF (max 10MB)</small>
                </div>

                <div *ngIf="posterPreview || eventData.poster_url" class="poster-preview">
                  <img [src]="posterPreview || eventData.poster_url" alt="Event poster">
                  <button 
                    type="button" 
                    class="btn btn-sm btn-danger poster-remove-btn"
                    (click)="removePoster()">
                    <i class="fa fa-times"></i>
                  </button>
                </div>

                <input 
                  type="file" 
                  #posterInput
                  accept="image/*"
                  (change)="onPosterSelected($event)"
                  style="display: none;">
              </div>
            </div>
          </div>

          <!-- Ticket Purchase Section -->
          <div class="form-section" *ngIf="activeSection === 'purchase'">
            <h3>Ticket Purchase</h3>
            <p>Configure payment methods and ticket sales settings</p>

            <!-- Purchase Link -->
            <div class="row mb-4" *ngIf="event && event.buy_shortlink">
              <div class="col-12">
                <div class="card bg-light border-primary">
                  <div class="card-body">
                    <h5 class="card-title">
                      <i class="fa fa-link text-primary me-2"></i>Ticket Purchase Link
                    </h5>
                    <div class="input-group input-group-lg">
                      <input 
                        type="text" 
                        class="form-control" 
                        [value]="event.buy_shortlink"
                        readonly>
                      <button 
                        type="button" 
                        class="btn btn-primary"
                        (click)="copyToClipboard(event.buy_shortlink)"
                        title="Copy to clipboard">
                        <i class="fa fa-copy me-2"></i>Copy Link
                      </button>
                    </div>
                    <small class="text-muted mt-2 d-block">
                      <i class="fa fa-info-circle"></i> Share this link for customers to purchase tickets
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mb-4" *ngIf="!event || !event.buy_shortlink">
              <div class="col-12">
                <div class="alert alert-info">
                  <i class="fa fa-info-circle me-2"></i>
                  The ticket purchase link will be generated after publishing the event.
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-12 mb-4">
                <label class="form-label">Accepted Payment Methods</label>
                <div class="payment-methods-grid">
                  <div class="payment-method-card">
                    <input 
                      type="checkbox" 
                      id="gcash" 
                      [(ngModel)]="eventData.supports_gcash">
                    <label for="gcash">
                      <i class="fa fa-mobile-alt"></i>
                      <span>GCash</span>
                    </label>
                  </div>
                  <div class="payment-method-card">
                    <input 
                      type="checkbox" 
                      id="qrph" 
                      [(ngModel)]="eventData.supports_qrph">
                    <label for="qrph">
                      <i class="fa fa-qrcode"></i>
                      <span>QR Ph</span>
                    </label>
                  </div>
                  <div class="payment-method-card">
                    <input 
                      type="checkbox" 
                      id="card" 
                      [(ngModel)]="eventData.supports_card">
                    <label for="card">
                      <i class="fa fa-credit-card"></i>
                      <span>Credit/Debit Card</span>
                    </label>
                  </div>
                  <div class="payment-method-card">
                    <input 
                      type="checkbox" 
                      id="ubp" 
                      [(ngModel)]="eventData.supports_ubp">
                    <label for="ubp">
                      <i class="fa fa-university"></i>
                      <span>UnionBank</span>
                    </label>
                  </div>
                  <div class="payment-method-card">
                    <input 
                      type="checkbox" 
                      id="maya" 
                      [(ngModel)]="eventData.supports_maya">
                    <label for="maya">
                      <i class="fa fa-wallet"></i>
                      <span>Maya</span>
                    </label>
                  </div>
                  <div class="payment-method-card">
                    <input 
                      type="checkbox" 
                      id="grabpay" 
                      [(ngModel)]="eventData.supports_grabpay">
                    <label for="grabpay">
                      <i class="fa fa-car"></i>
                      <span>GrabPay</span>
                    </label>
                  </div>
                  <div class="payment-method-card">
                    <input 
                      type="checkbox" 
                      id="dob" 
                      [(ngModel)]="eventData.supports_dob">
                    <label for="dob">
                      <i class="fa fa-landmark"></i>
                      <span>Direct Online Banking</span>
                    </label>
                  </div>
                </div>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Ticket Sales Close Time</label>
                <input 
                  type="datetime-local" 
                  class="form-control" 
                  [(ngModel)]="eventData.close_time"
                  placeholder="Optional - leave empty to close at event time">
                <small class="form-text text-muted d-flex align-items-center gap-2 mt-2">
                  <i class="fa fa-clock"></i>
                  Set suggested time:
                  <button type="button" class="btn btn-sm btn-outline-secondary" (click)="setSuggestedCloseTime('1h')">1h before</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" (click)="setSuggestedCloseTime('3h')">3h before</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" (click)="setSuggestedCloseTime('1d')">1 day before</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" (click)="setSuggestedCloseTime('3d')">3 days before</button>
                </small>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Show Countdown on Ticket Page</label>
                <select class="form-select" [(ngModel)]="eventData.countdown_display">
                  <option value="always">Always show</option>
                  <option value="1_week">1 week before</option>
                  <option value="3_days">3 days before</option>
                  <option value="1_day">1 day before</option>
                  <option value="never">Never show</option>
                </select>
                <small class="form-text text-muted">
                  <i class="fa fa-info-circle"></i> Choose when to display a countdown timer on the ticket purchase page.
                </small>
              </div>

              <div class="col-12 mb-3">
                <div class="form-check">
                  <input 
                    type="checkbox" 
                    class="form-check-input" 
                    id="showTicketsRemaining"
                    [(ngModel)]="eventData.show_tickets_remaining">
                  <label class="form-check-label" for="showTicketsRemaining">
                    Show tickets remaining on purchase page
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Ticket Types Section -->
          <div class="form-section" *ngIf="activeSection === 'ticket-types'">
            <h3>Ticket Types</h3>
            <p>Configure ticket types, pricing, and availability</p>

            <div class="ticket-types-list">
              <div class="ticket-type-item" *ngFor="let ticket of ticketTypes; let i = index">
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Ticket Name *</label>
                    <input 
                      type="text" 
                      class="form-control" 
                      [(ngModel)]="ticket.name"
                      placeholder="e.g., General Admission, VIP">
                  </div>
                  <div class="col-md-3 mb-3">
                    <label class="form-label">Price (â‚±) *</label>
                    <input 
                      type="number" 
                      class="form-control" 
                      [(ngModel)]="ticket.price"
                      min="0"
                      step="0.01">
                  </div>
                  <div class="col-md-3 mb-3">
                    <label class="form-label">Max Tickets *</label>
                    <input 
                      type="number" 
                      class="form-control" 
                      [(ngModel)]="ticket.max_tickets"
                      min="1">
                  </div>
                  <div class="col-md-2 mb-3 d-flex align-items-end">
                    <button 
                      type="button" 
                      class="btn btn-danger w-100" 
                      (click)="removeTicketType(i)">
                      <i class="bi bi-trash"></i> Remove
                    </button>
                  </div>
                </div>
                
                <div class="row" *ngIf="ticket.start_date !== undefined">
                  <div class="col-md-5 mb-3">
                    <label class="form-label">Start Date (Optional)</label>
                    <input 
                      type="datetime-local" 
                      class="form-control" 
                      [(ngModel)]="ticket.start_date">
                  </div>
                  <div class="col-md-5 mb-3">
                    <label class="form-label">End Date (Optional)</label>
                    <input 
                      type="datetime-local" 
                      class="form-control" 
                      [(ngModel)]="ticket.end_date">
                  </div>
                  <div class="col-md-2 mb-3 d-flex align-items-end">
                    <button 
                      type="button" 
                      class="btn btn-outline-secondary w-100" 
                      (click)="toggleTicketTypeDateRange(ticket)">
                      Clear Dates
                    </button>
                  </div>
                </div>
              </div>

              <button 
                type="button" 
                class="btn btn-outline-primary" 
                (click)="addTicketType()">
                <i class="bi bi-plus-circle"></i> Add Ticket Type
              </button>

              <div class="alert alert-info mt-3" *ngIf="ticketTypes.length === 0">
                <i class="bi bi-info-circle"></i> No ticket types added yet. Click "Add Ticket Type" to create your first ticket type.
              </div>
            </div>
          </div>

          <!-- Scanner Section -->
          <div class="form-section" *ngIf="activeSection === 'scanner'">
            <h3>Scanner & Verification</h3>
            <p>Ticket scanning and verification settings</p>

            <!-- Verification Link -->
            <div class="row mb-4" *ngIf="event && event.verification_link">
              <div class="col-12">
                <div class="card bg-light border-primary">
                  <div class="card-body">
                    <h5 class="card-title">
                      <i class="fa fa-qrcode text-primary me-2"></i>Verification Link
                    </h5>
                    <div class="input-group input-group-lg">
                      <input 
                        type="text" 
                        class="form-control" 
                        [value]="event.verification_link"
                        readonly>
                      <button 
                        type="button" 
                        class="btn btn-primary"
                        (click)="copyToClipboard(event.verification_link)"
                        title="Copy to clipboard">
                        <i class="fa fa-copy me-2"></i>Copy Link
                      </button>
                    </div>
                    <small class="text-muted mt-2 d-block">
                      <i class="fa fa-info-circle"></i> Share this link with ticket scanners
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mb-4" *ngIf="!event || !event.verification_link">
              <div class="col-12">
                <div class="alert alert-info">
                  <i class="fa fa-info-circle me-2"></i>
                  The verification link will be generated after publishing the event.
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Verification PIN</label>
                <div class="input-group">
                  <input 
                    type="text" 
                    class="form-control" 
                    [(ngModel)]="eventData.verification_pin"
                    placeholder="6-digit PIN"
                    maxlength="6"
                    pattern="[0-9]{6}">
                  <button 
                    type="button" 
                    class="btn btn-outline-secondary"
                    (click)="generateVerificationPIN()"
                    title="Generate random PIN">
                    <i class="fas fa-sync"></i>
                  </button>
                </div>
                <small class="form-text text-muted">
                  <i class="fa fa-info-circle"></i> 6-digit PIN for ticket scanners to verify tickets
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Floating Action Buttons (outside scrollable container) -->
<div class="floating-actions">
  <!-- Cancel button only shown when creating a new event -->
  <button 
    type="button" 
    class="btn btn-outline-secondary"
    (click)="onCancel()"
    [disabled]="saving"
    *ngIf="isNewEvent">
    Cancel
  </button>

  <!-- Draft Event Buttons -->
  <ng-container *ngIf="isEventDraft()">
    <button 
      type="button" 
      class="btn btn-outline-primary"
      (click)="onSave()"
      [disabled]="saving">
      <i class="fa fa-spinner fa-spin" *ngIf="saving"></i>
      <i class="fa fa-save" *ngIf="!saving"></i>
      <span *ngIf="!saving">Save as Draft</span>
      <span *ngIf="saving">Saving...</span>
    </button>
    <button 
      type="button" 
      class="btn btn-success"
      (click)="onPublish()"
      [disabled]="saving">
      <i class="fa fa-spinner fa-spin" *ngIf="saving"></i>
      <i class="fa fa-rocket" *ngIf="!saving"></i>
      <span *ngIf="!saving">Publish</span>
      <span *ngIf="saving">Publishing...</span>
    </button>
  </ng-container>

  <!-- Published Event Buttons -->
  <ng-container *ngIf="isEventPublished()">
    <button 
      type="button" 
      class="btn btn-primary"
      (click)="onSave()"
      [disabled]="saving || !isFormDirty()">
      <i class="fa fa-spinner fa-spin" *ngIf="saving"></i>
      <i class="fa fa-save" *ngIf="!saving"></i>
      <span *ngIf="!saving">Save Changes</span>
      <span *ngIf="saving">Saving...</span>
    </button>
    <button 
      type="button" 
      class="btn btn-warning"
      (click)="onUnpublish()"
      [disabled]="saving || hasConfirmedTickets()"
      *ngIf="!hasConfirmedTickets()">
      <i class="fa fa-spinner fa-spin" *ngIf="saving"></i>
      <i class="fa fa-eye-slash" *ngIf="!saving"></i>
      <span *ngIf="!saving">Unpublish</span>
      <span *ngIf="saving">Unpublishing...</span>
    </button>
  </ng-container>
</div>
