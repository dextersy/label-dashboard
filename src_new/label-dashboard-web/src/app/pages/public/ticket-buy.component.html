<div class="public-page" [style.background-color]="brandColor">
  <!-- Loading Overlay -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading"></div>
  </div>

  <!-- Error State (404) -->
  <div *ngIf="isError" class="wrapper h-100 d-flex justify-content-center align-items-center">
    <div class="card text-center" style="max-width: 500px;">
      <div class="card-body py-5">
        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
        <h1 class="text-danger">404 - Event Not Found</h1>
        <p class="text-muted">The event you're looking for could not be found.</p>
        <button class="btn btn-primary" (click)="goBack()">
          <i class="fas fa-arrow-left me-1"></i>Go Back
        </button>
      </div>
    </div>
  </div>

  <!-- Content shown only when event is loaded -->
  <div *ngIf="!isLoading && !isError && event" class="wrapper fadeInDown h-100">
    <!-- Header Section -->
    <div class="header-section">
      <div class="container">
        <div class="row align-items-center h-100">
          <div class="col-md-4 event-poster-container" *ngIf="event.poster_url">
            <img [src]="event.poster_url" class="event-poster" alt="Event poster">
          </div>
          <div [class]="event.poster_url ? 'col-md-8' : 'col-md-12 text-center'" style="padding:30px;">
            <div *ngIf="!event.is_closed && (!event.remaining_tickets || (event.remaining_tickets != null && event.remaining_tickets > 0))">
              <h5>Get tickets to</h5>
              <h1><strong>{{ event.title }}</strong></h1>
              <h5><strong>{{ formatEventDate(event.date_and_time) }}</strong> at <strong>{{ event.venue }}</strong></h5>
              <small>{{ event.description }}</small>
            </div>
            <div *ngIf="event.is_closed || (event.remaining_tickets != null && event.remaining_tickets <= 0)">
              <h1 style="font-size:2.5rem;font-weight:bold;">Sorry, we're closed...</h1>
              <h1 style="font-size:1.5rem;font-style:italic;">â€” but the door's still open!</h1>
              <h3>&nbsp;</h3>
              <h5>Online ticket sales for <b>{{ event.title }}</b> has already ended. ðŸ¥²</h5>
              <h5>But don't worry â€” tickets or walk-in may still be available at the show!</h5>
              <p>
                Please check <strong>{{ event.brand?.name || 'the event organizer' }}</strong> social media or the event page for more information.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Body Section -->
    <div class="body-section" *ngIf="!event.is_closed && (!event.remaining_tickets || (event.remaining_tickets != null && event.remaining_tickets > 0))">
      <form [formGroup]="ticketForm" (ngSubmit)="onSubmit()">
        <div class="container">
          <div class="row h-50">
            <div class="col-md-7">
              <h6><strong>Step 1.</strong> Please provide your details.</h6>

              <!-- Name Field -->
              <div class="name-container fadeIn first">
                <div class="input-group">
                  <div class="form-floating flex-fill">
                    <input 
                      type="text" 
                      class="form-control" 
                      id="name"
                      formControlName="name"
                      placeholder="Full name"
                      [class.is-invalid]="isFieldInvalid('name')"
                      required>
                    <label for="name">Full name</label>
                  </div>
                </div>
                <div class="invalid-feedback d-block" 
                     *ngIf="isFieldInvalid('name')">
                  Full name is required.
                </div>
                <div class="valid-feedback d-block" 
                     *ngIf="!isFieldInvalid('name') && ticketForm.get('name')?.value">
                  <i class="fas fa-check-circle text-success"></i>
                  Please make sure your full name is as it appears on your identification.
                </div>
              </div>

              <!-- Email Field -->
              <div class="email-container fadeIn second">
                <div class="input-group">
                  <div class="form-floating flex-fill">
                    <input 
                      type="email" 
                      class="form-control" 
                      id="email_address"
                      formControlName="email_address"
                      placeholder="Email address"
                      [class.is-invalid]="isFieldInvalid('email_address')"
                      required>
                    <label for="email_address">Email address</label>
                  </div>
                </div>
                <div class="invalid-feedback d-block" 
                     *ngIf="ticketForm.get('email_address')?.errors?.['required']">
                  Email address is required.
                </div>
                <div class="invalid-feedback d-block" 
                     *ngIf="ticketForm.get('email_address')?.errors?.['email']">
                  Email address is not valid.
                </div>
                <div class="valid-feedback d-block" 
                     *ngIf="!isFieldInvalid('email_address') && ticketForm.get('email_address')?.value">
                  <i class="fas fa-check-circle text-success"></i>
                  Please make sure your email address is correct.
                </div>
              </div>

              <!-- Contact Number Field -->
              <div class="contact-number-container fadeIn third">
                <div class="input-group">
                  <span class="input-group-text">ðŸ‡µðŸ‡­ +63</span>
                  <div class="form-floating flex-fill">
                    <input 
                      type="text" 
                      class="form-control" 
                      id="contact_number"
                      formControlName="contact_number"
                      placeholder="Contact number"
                      [class.is-invalid]="isFieldInvalid('contact_number')">
                    <label for="contact_number">Contact number</label>
                  </div>
                </div>
                <div class="invalid-feedback d-block" 
                     *ngIf="isFieldInvalid('contact_number')">
                  Contact number is required.
                </div>
              </div>

              <!-- Number of Tickets -->
              <h6 class="fadeIn fourth"><strong>How many tickets are you getting?</strong></h6>
              <small class="fadeIn fourth" *ngIf="event.remaining_tickets">
                <strong>{{ event.remaining_tickets }}</strong> tickets available.
              </small>
              <div class="ticket-quantity-container fadeIn fourth">
                <div class="input-group">
                  <span class="input-group-text">
                    {{ event.ticket_naming || 'Regular' }} - <strong>â‚±{{ formatPrice(event.ticket_price) }}</strong>
                  </span>
                  <div class="form-floating flex-fill">
                    <input 
                      type="number" 
                      min="1" 
                      [max]="event.remaining_tickets || 99" 
                      step="1" 
                      class="form-control" 
                      id="number_of_entries"
                      formControlName="number_of_entries"
                      placeholder="Number of tickets"
                      (input)="calculateTotal()"
                      [class.is-invalid]="isFieldInvalid('number_of_entries')">
                    <label for="number_of_entries">Number of tickets</label>
                  </div>
                </div>
                <div class="invalid-feedback d-block" 
                     *ngIf="isFieldInvalid('number_of_entries')">
                  Number of tickets is required.
                </div>
              </div>

              <!-- Referral Code -->
              <div class="referral-code-container fadeIn fifth" *ngIf="!referralCode">
                <div class="input-group">
                  <div class="form-floating flex-fill">
                    <input 
                      type="text" 
                      class="form-control" 
                      id="referral_code"
                      formControlName="referral_code"
                      placeholder="Referral code (optional)">
                    <label for="referral_code">Referral code (optional)</label>
                  </div>
                </div>
              </div>
              <div *ngIf="referralCode" class="referral-code-display fadeIn fifth">
                <strong>Referral code: </strong><span class="badge bg-info text-white">{{ referralCode }}</span>
              </div>
            </div>

            <div class="col-md-5">
              &nbsp;
              
              <h6><i class="fas fa-info-circle"></i> <strong>Important reminders before submitting</strong></h6>
              <div class="alert alert-info field-description text-dark">
                <ul>
                  <li>Please use a name that is shown in any valid ID, as you may be requested to present identification at the gate.</li>
                  <li>Please make sure your email address is correct to make sure that you receive your ticket without any problem.</li>
                  <li>Tickets are non-refundable once paid.</li>
                </ul>
              </div>
              
              <!-- Payment Calculation -->
              <div id="div_paymentCalculation" [style.display]="totalAmount > 0 ? 'block' : 'none'">
                <hr>
                <h5>Total amount is <b>â‚±{{ formatPrice(totalAmount) }}</b>.</h5>
                <hr>
              </div>

              <!-- Privacy Consent -->
              <div class="privacy-consent-container">
                <mat-checkbox 
                  formControlName="privacy_consent"
                  class="field-description"
                  [class.mat-checkbox-invalid]="isFieldInvalid('privacy_consent')">
                  I agree to share my data to {{ event.brand?.name || 'the event organizer' }} and its affiliates for the sole purpose of processing my purchase of tickets.
                </mat-checkbox>
                <div class="error-message" 
                     *ngIf="isFieldInvalid('privacy_consent')">
                  You need to accept the privacy consent to proceed.
                </div>
              </div>

              <button 
                mat-raised-button 
                color="primary"
                type="submit" 
                class="submit-button w-100"
                [disabled]="ticketForm.invalid || isSubmitting">
                <i class="fas fa-credit-card me-1"></i>
                {{ isSubmitting ? 'Processing...' : 'Proceed to Payment' }}
              </button>
              <div class="fadeIn sixth" style="font-size:12px;">
                Clicking <b>Proceed to Payment</b> will bring you to our Paymongo checkout page. 
                Payee information will be <strong>Melt Records</strong>.
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Footer -->
    <div class="text-center">
      <p>&nbsp;</p>
      <p>
        <span style="font-size:12px; font-weight:bold;">Powered by Melt Records Dashboard.</span><br>
        <span style="font-size:12px; font-style:italic;">
          Having trouble? Contact us via email 
          <a [href]="'mailto:support@melt-records.com?subject=Issue with ticketing for ' + event.title">here</a> 
          or use the chat widget on the lower right.
        </span>
      </p>
    </div>
  </div>
</div>